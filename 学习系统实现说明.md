# 4槽并行学习系统实现说明

## 一、新增 State 字段

已在 `game.js` 的 `state` 对象中添加以下字段：

```javascript
// 学习队列（循环队列，存 courseId）
studyQueue: [],

// 4个并行学习槽（存 courseId，null 表示空槽）
studySlots: [null, null, null, null],

// 每门课的学习进度
courseProgress: {}, // { courseId: { stage: 1|2, points: number, doneStage2: boolean } }

// 课程难度缓存（避免重复计算）
courseDifficulty: {}, // { courseId: difficulty }

// 阶段阈值
THRESHOLD_B: 2.2,        // stage 1 完成阈值（达到B）
THRESHOLD_A_PLUS: 4.5,   // stage 2 完成阈值（达到A+）

// 难度→进度增量映射
DIFFICULTY_TO_POINTS: {
  1: 2.0,
  2: 1.0,
  3: 0.5,
  4: 0.3,
  5: 0.2,
},
```

## 二、核心函数实现

### 1. `calculateCourseDifficulty(course)`
计算课程难度（1-5档）

**规则：**
- 选修课、体育课 → difficulty = 1
- 英语类、思政类 → difficulty = 2
- 其余专业课 → 按学分映射（1学分→2，2学分→3，3学分→4，4学分及以上→5）

### 2. `initQueue()`
学期开始时初始化学习队列

**功能：**
- 计算每门课的 difficulty
- 按 difficulty 升序排序
- 生成队列（存 courseId）
- 初始化每门课的进度数据

### 3. `advanceCourse(courseId)`
推进指定课程的学习进度

**返回值：**
- 如果完成阶段1（达到B），返回 `{ stage: 1, courseId }`
- 如果完成阶段2（达到A+），返回 `{ stage: 2, courseId }`
- 否则返回 `null`

### 4. `runStudyOnce()`
执行一次学习动作（消耗4个tick）

**流程：**
1. 初始化 `temporaryCooldownThisAction` 集合
2. 循环处理4个tick：
   - 先补空槽（从队列头部取课程）
   - 推进当前槽中的课程
   - 如果完成阶段，处理轮转逻辑
3. 返回学习日志数组

**阶段完成处理：**
- Stage 1 完成：放入队列尾部，槽立即空出
- Stage 2 完成：从队列移除，槽立即空出

### 5. `finalizeGrades()`
根据学习进度生成期末成绩

**逻辑：**
- `doneStage2 = true` → A+ (95-100)
- `stage = 2` 且进度高 → A (90-94) 或 A- (85-89) 或 B+ (82-84)
- `stage = 1` → 根据进度生成 B 及以下等级

## 三、接入现有系统

### 1. 学习动作接入
已修改 `doStudyAction()`：
- 检查队列是否初始化，未初始化则调用 `initQueue()`
- 调用 `runStudyOnce()` 执行学习调度
- 输出学习日志和槽状态

### 2. 期末结算接入
已修改 `finalizeTermGrades()`：
- 使用 `finalizeGrades()` 生成成绩
- 保留原有的 GPA 计算和 UI 渲染逻辑
- 学期结束时清空学习系统状态

### 3. 队列初始化时机
在以下位置调用 `initQueue()`：
- 学期开始时（`nextWeek()` 中，进入新学期时）
- 自动选课后（`autoPlanThisTerm()` 结束时）
- 游戏开始时（`startGame()` 中，选课后）
- 退补选时（加课/退课后）
- 自动排冲突后

## 四、使用说明

### 学习流程
1. 玩家点击"学习"按钮
2. 系统消耗1次行动，执行 `runStudyOnce()`
3. 4个tick依次处理：
   - 空槽从队列头部补入课程
   - 推进槽中课程的学习进度
   - 完成阶段时进行轮转
4. 输出学习日志和槽状态

### 阶段说明
- **Stage 1（冲B）**：从0开始，达到 `THRESHOLD_B` (2.2) 后进入 Stage 2
- **Stage 2（冲A+）**：从0开始，达到 `THRESHOLD_A_PLUS` (4.5) 后完成

### 难度与进度
- 难度越低，每次推进的进度增量越大
- 难度1（选修/体育）→ +2.0
- 难度2（英语/思政）→ +1.0
- 难度3（2学分专业课）→ +0.5
- 难度4（3学分专业课）→ +0.3
- 难度5（4学分及以上）→ +0.2

## 五、注意事项

1. **队列初始化**：确保在选课后立即初始化队列
2. **课程变化**：任何修改 `coursesThisTerm` 的操作后都应重新初始化队列
3. **进度持久化**：`courseProgress` 在学期内保持，学期结束时清空
4. **防止重复刷课**：使用 `temporaryCooldownThisAction` 确保一次学习动作中不会重复处理同一课程

## 六、调试建议

可以在控制台查看以下状态：
```javascript
// 查看队列
console.log(state.studyQueue);

// 查看槽状态
console.log(state.studySlots);

// 查看进度
console.log(state.courseProgress);

// 查看难度
console.log(state.courseDifficulty);
```

