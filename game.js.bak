// game.js
// =========================
// å¤§å­¦ç”Ÿæ¨¡æ‹Ÿå™¨ v0.4ï¼ˆç¤¾äº¤ç³»ç»Ÿ + å¼ºåˆ¶è¯¾é”æ­» + æ— å†²çªé€‰è¯¾ + CET4/6ï¼‰
// - course.js -> window.COURSE.generatePlan
// - grade_rule.js -> window.GRADING
// - event.js -> window.EVENTS + window.eventMatchesState
// =========================

/* ========== å¸¸é‡ ========== */
const TERM_WEEKS = 16;
const TERMS_PER_YEAR = 2;
const ACTIONS_PER_WEEK = 3;                 // âœ… ä¸€å‘¨åªèƒ½åš 3 ä»¶äº‹
const FINALS_WEEKS = [14, 15, 16];

const FAMILY_ALLOWANCE_MONTHLY = { poor: 800, ok: 1500, mid: 3000, rich: 8000 };
const ASK_PARENTS_AMOUNT = { poor: 0, ok: 200, mid: 1000, rich: 2000 };

const WORK_REWARD = 400;
const WORK_ENERGY_COST = 15;
const WORK_STRESS_COST = 10;

const MONTHLY_ESSENTIALS_MIN = 200;
const MONTHLY_ESSENTIALS_MAX = 400;
const MONTHLY_PHONE_TOPUP = 50;
const EXAM_MATERIALS_COST = 50;

const LIVING_COST_MULTIPLIER = 1.08;

const ACADEMY_STUDY_STRESS_MULT = {
  "æ–‡ç§‘/ç¤¾ç§‘": 0.85,
  "å•†ç§‘": 1.00,
  "ç†å·¥": 1.18,
  "åŒ»å­¦": 1.35
};

/* ========== å·¥å…·å‡½æ•° ========== */
const clamp = (n, a, b) => Math.max(a, Math.min(b, n));
const rndInt = (a, b) => Math.floor(Math.random() * (b - a + 1)) + a;
const chance = (p) => Math.random() < p;
const byId = (id) => document.getElementById(id);

function setText(el, txt) { if (el) el.textContent = String(txt); }
function setHTML(el, html) { if (el) el.innerHTML = html; }
function setDisabled(el, v) { if (el) el.disabled = !!v; }
function setWidth(el, w) { if (el) el.style.width = w; }

/* ========== æ—¶é—´å‡½æ•°ï¼ˆ4å‘¨=1æœˆï¼‰ ========== */
function termMonthIndex() { return Math.ceil(state.week / 4); }
function currentMonthIndex() {
  return (state.year - 1) * (TERMS_PER_YEAR * 4) + (state.term - 1) * 4 + termMonthIndex();
}
function isFirstWeekOfMonth() { return (state.week % 4) === 1; }
function isExamMonth() { return termMonthIndex() === 4; }
function termIndex1to8() { return (state.year - 1) * 2 + state.term; } // 1..8

function tierName(tier) {
  return tier === "poor" ? "è´«å›°"
    : tier === "ok" ? "å°åº·"
    : tier === "mid" ? "ä¸­äº§"
    : tier === "rich" ? "å¯ŒäºŒä»£"
    : "æœªçŸ¥";
}

// fallbackï¼šå¦‚æœæ²¡æœ‰ GRADING.percentToGradePointï¼Œå°±ç”¨è¿™ä¸ªç²—ç•¥ç®—
function percentToGP(percent) {
  if (percent < 60) return 0;
  return clamp(percent / 10 - 5, 0, 5);
}

/* ========== ç¤¾äº¤å¯¹è´Ÿé¢å¿ƒæƒ…ä¸‹é™æ‰“æŠ˜ï¼ˆä½ è¦æ±‚ï¼š>90 æ‰“ 0.8ï¼‰ ========== */
function applyMoodDelta(delta) {
  let d = Number(delta || 0);
  if (d < 0 && (state.social ?? 0) > 90) d = Math.round(d * 0.8);
  state.mood = clamp(state.mood + d, 0, 100);
}

/* ========== æš—çº¿ ========== */
const hiddenProfile = {
  academicPower: 0,
  researchPower: 0,
  careerPower: 0,
  englishPower: 0,
  stability: 100,
  luck: rndInt(30, 70) // åŸºç¡€å¥½è¿ï¼ˆä¼šè¢«ç¤¾äº¤â€œåŠ æˆâ€ï¼‰
};

/* ========== æ ¸å¿ƒçŠ¶æ€ ========== */
const state = {
  year: 1, term: 1, week: 1,
  actionsLeft: ACTIONS_PER_WEEK,

  energy: 60, stress: 40, mood: 50,
  money: 0,

  // âœ… ç¤¾äº¤å±æ€§
  social: 50,

  academy: null,
  academyNormalized: null,
  familyTier: null,
  familyMonthlyAllowance: 0,
  familyLocked: false,

  lastAskParentsMonth: null,

  curriculumPlan: null,
  graduationCreditsRequired: 0,
  creditsEarnedTotal: 0,

  // è¯¾ç¨‹
  allCoursesPool: [],
  coursesThisTerm: [],
  termCredits: 0,
  hasPickedWeek1: false,
  hasAdjustedWeek3: false,
  conflictsResolved: false,

  examSchedule: {},
  examConflicts: [],

  // å­¦ä¹ ç›¸å…³ï¼ˆæŒ‰è¯¾ç¨‹åˆ†é…ï¼‰
  totalStudyThisTerm: 0,
  finalsStudyWeeksThisTerm: 0,
  termGradeBonus: 0,                 // clamp -5..+5

  studyActionsByCourseId: {},
  masteredCourseIds: [],

  route: null,

  // âœ… CET å‡†å¤‡
  cetPrepThisTerm: 0,
  flags: { cet4: false, cet6: false },

  // GPA
  gpaRecord: {},
  termGPA: 0,
  cumGPA: 0,
  termGPARevealed: false,
  failedCoursesPrimary: 0,
  everFailed: false,
  disciplineFlag: false,
  recommendFlag: false,

  // äº‹ä»¶
  currentEvent: null,
  eventPending: false,
  eventCooldown: {},
  recentEventIds: [],
  eventDeck: [],

  // æˆç»©å•
  gradeHistory: [],
  lastTermReport: null,

  // å¾…å…¬å¸ƒæˆç»©ï¼ˆæ–°å­¦æœŸç¬¬1å‘¨å…¬å¸ƒï¼‰
  pendingTermReport: null,

  // ç ´äº§é”æ­»
  isBankruptLocked: false,

  // ä¼‘å­¦åˆ¤å®š
  depressionWeeks: 0,

  // è½»é‡ç§‘ç ”æˆæœè®¡æ•°ï¼ˆç»™ä½ æœªæ¥æ‰©å±•â€œè®ºæ–‡/SCIâ€ï¼‰
  sciCount: 0
};

/* ========== UI ç»‘å®š ========== */
const ui = {
  tabs: Array.from(document.querySelectorAll(".tab")),
  tabPages: {
    tabOverview: byId("tabOverview"),
    tabWeek: byId("tabWeek"),
    tabCourses: byId("tabCourses")
  },

  // time/status (fallbacks to newer ids)
  year: byId("year") || byId("metaTerm"),
  term: byId("term") || byId("metaTerm"),
  week: byId("week") || byId("metaWeek"),
  actionsLeft: byId("actionsLeft") || byId("txtActionsLeft"),
  familyTier: byId("familyTier"), academyName: byId("academyName"),

  // stats display (txtX or legacy X)
  energy: byId("energy") || byId("txtEnergy"),
  stress: byId("stress") || byId("txtStress"),
  mood: byId("mood") || byId("txtMood"),
  social: byId("social") || byId("txtSocial"),
  money: byId("money") || byId("txtMoney"),

  barEnergy: byId("barEnergy"), barStress: byId("barStress"), barMood: byId("barMood"),
  barSocial: byId("barSocial"),
  barMoney: byId("barMoney"),

  gradCreditsReq: byId("gradCreditsReq"),
  creditsEarnedTotal: byId("creditsEarnedTotal"),
  termCredits: byId("termCredits"),
  courseCount: byId("courseCount") || byId("courseList"),

  termGPA: byId("termGPA"),
  cumGPA: byId("cumGPA"),
  failedCourses: byId("failedCourses"),
  disciplineFlag: byId("disciplineFlag"),
  recommendFlag: byId("recommendFlag"),

  cet4Flag: byId("cet4Flag"),
  cet6Flag: byId("cet6Flag"),
  certList: byId("certList"),

  statusHint: byId("statusHint"),
  log: byId("log") || byId("logBox"),

  // æ¦‚è§ˆæŒ‰é’®
  btnAcadArts: byId("btnAcaArts") || byId("btnAcadArts"),
  btnAcadBiz: byId("btnAcaBiz") || byId("btnAcadBiz"),
  btnAcadSci: byId("btnAcaStem") || byId("btnAcadSci"),
  btnAcadMed: byId("btnAcaMed") || byId("btnAcadMed"),
  planPreview: byId("planPreview") || byId("txtAcaHint"),

  btnTierPoor: byId("btnFamPoor") || byId("btnTierPoor"),
  btnAutoPlan: byId("btnAutoPlan"),
  btnOpenAddDrop: byId("btnOpenAddDrop"),
  modalAddDrop: byId("modalAddDrop"),
  btnResolveConflicts: byId("btnResolveConflicts"),
  btnCloseAddDrop: byId("btnCloseAddDrop"),
  adCurrent: byId("adCurrent"),
  adPool: byId("adPool"),
  btnTierOk: byId("btnFamOk") || byId("btnTierOk"),
  btnTierMid: byId("btnFamMid") || byId("btnTierMid"),
  btnTierRich: byId("btnFamRich") || byId("btnTierRich"),

  // è¡ŒåŠ¨é¢æ¿ï¼ˆåŠ¨æ€ç”ŸæˆæŒ‰é’®åˆ° actionPanelï¼‰
  actionPanel: byId("actionPanel"),
  btnNextWeek: byId("btnNextWeek"),

  // äº‹ä»¶å¡ç‰‡
  eventCard: byId("eventCard"),
  eventTitle: byId("evTitle") || byId("eventTitle"),
  eventText: byId("evText") || byId("eventText"),
  eventOptions: byId("evOptions") || byId("eventOptions"),
  noEventHint: byId("noEventHint"),
  modalEvent: byId("modalEvent"),

  // é€‰è¯¾&è€ƒè¯•
  btnOpenCoursePicker: byId("btnOpenCoursePicker"),
  btnOpenAdjust: byId("btnOpenAdjust"),
  btnOpenExamView: byId("btnOpenExamView"),
  courseSummary: byId("courseSummary"),
  conflictBox: byId("conflictBox"),

  modalCourse: byId("modalCourse"),
  btnCloseCourse: byId("btnCloseCourse"),
  modalCourseHint: byId("modalCourseHint"),
  courseList: byId("courseList"),
  selectedInfo: byId("selectedInfo"),
  btnAutoPick: byId("btnAutoPick"),
  btnConfirmPick: byId("btnConfirmPick"),

  modalAdjust: byId("modalAdjust"),
  btnCloseAdjust: byId("btnCloseAdjust"),
  adjustBody: byId("adjustBody"),
  btnConfirmAdjust: byId("btnConfirmAdjust"),

  modalExam: byId("modalExam"),
  btnCloseExam: byId("btnCloseExam"),
  examBody: byId("examBody"),

  // æˆç»©å•
  gradeTermHeader: byId("gradeTermHeader"),
  gradeTable: byId("gradeTable"),
  gradeHistory: byId("gradeHistory"),

  // ç ´äº§ modal
  modalBankrupt: byId("bankruptPanel"),
  btnAskParentsCenter: byId("btnAskParents"),
  btnWorkCenter: byId("btnWork")
};

/* ========== æ—¥å¿— ========== */
function logLine(text) {
  if (!ui.log) return;
  const div = document.createElement("div");
  div.className = "line";
  div.textContent = text;
  ui.log.appendChild(div);
  ui.log.scrollTop = ui.log.scrollHeight;
}

/* ========== Tab åˆ‡æ¢ ========== */
function setTab(id) {
  ui.tabs.forEach(b => b.classList.toggle("active", b.dataset.tab === id));
  Object.entries(ui.tabPages).forEach(([k, el]) => {
    if (!el) return;
    const show = (k === id);
    el.classList.toggle("hidden", !show);
    el.style.display = show ? "" : "none";
  });
  render();
}
ui.tabs.forEach(b => b.addEventListener("click", () => setTab(b.dataset.tab)));

/* ========== å¼€å±€åˆ¤å®š ========== */
function isReadyToPlaySilent() {
  return !!(state.academy && state.curriculumPlan && state.familyTier);
}
function isReadyToPlay() {
  if (!state.academy || !state.curriculumPlan) { logLine("ã€æç¤ºã€‘å…ˆé€‰å­¦é™¢ç”ŸæˆåŸ¹å…»æ–¹æ¡ˆã€‚"); return false; }
  if (!state.familyTier) { logLine("ã€æç¤ºã€‘å†é€‰å®¶å¢ƒï¼ˆå¼€å±€é”æ­»ï¼‰ã€‚"); return false; }
  return true;
}

/* ========== ç ´äº§é”æ­» ========== */
function checkBankruptcyLock() {
  if (!isReadyToPlaySilent()) return;
  const lock = state.money <= 0;
  if (lock && !state.isBankruptLocked) {
    state.isBankruptLocked = true;
    logLine("ã€ç ´äº§ã€‘é‡‘é’±=0ï¼šè¡ŒåŠ¨é”æ­»ï¼Œå…ˆè¦é’±/æ‰“å·¥ï¼ˆå¼¹çª—ï¼‰ã€‚");
  }
  if (!lock && state.isBankruptLocked) {
    state.isBankruptLocked = false;
    logLine("ã€è§£é”ã€‘ç°é‡‘æµæ¢å¤ï¼Œå¯ä»¥ç»§ç»­è¡ŒåŠ¨ã€‚");
  }
}
function openBankruptModalIfNeeded() {
  if (!ui.modalBankrupt) return;
  if (state.isBankruptLocked) ui.modalBankrupt.classList.remove("hidden");
  else ui.modalBankrupt.classList.add("hidden");
}

/* ========== ç°é‡‘æµ ========== */
function spend(amount, reason) {
  const before = state.money;
  state.money = Math.max(0, state.money - amount);
  logLine(`ã€æ”¯å‡ºã€‘${reason} -${amount}ï¼ˆ${before}â†’${state.money}ï¼‰`);
  checkBankruptcyLock();
}
function getDailyExpenseRangeByTier() {
  if (state.familyTier === "poor") return { min: 15, max: 28 };
  if (state.familyTier === "ok") return { min: 28, max: 65 };
  if (state.familyTier === "mid") return { min: 60, max: 140 };
  if (state.familyTier === "rich") return { min: 70, max: 180 };
  return { min: 25, max: 70 };
}
function applyWeeklyLivingExpenses() {
  if (!state.familyTier) return;
  const { min, max } = getDailyExpenseRangeByTier();
  let weekly = 0;
  for (let i = 0; i < 7; i++) weekly += rndInt(min, max);
  weekly = Math.floor(weekly * LIVING_COST_MULTIPLIER);
  state.money = Math.max(0, state.money - weekly);
  logLine(`ã€å›ºå®šå¼€é”€ã€‘æœ¬å‘¨ç”Ÿæ´»å¼€é”€ -${weekly}ï¼ˆæ¯æ—¥${min}-${max}Ã—7ï¼‰ã€‚`);
  checkBankruptcyLock();
}
function applyMonthlyFixedCosts() {
  spend(rndInt(MONTHLY_ESSENTIALS_MIN, MONTHLY_ESSENTIALS_MAX), "æ—¥ç”¨å“/æ‚é¡¹");
  spend(MONTHLY_PHONE_TOPUP, "æ‰‹æœºå……å€¼");
  if (isExamMonth()) spend(EXAM_MATERIALS_COST, "è€ƒè¯•æœˆå¤ä¹ èµ„æ–™");
}
function giveMonthlyAllowanceIfNeeded() {
  if (!state.familyTier) return;
  if (isFirstWeekOfMonth()) {
    const g = state.familyMonthlyAllowance;
    const before = state.money;
    state.money += g;
    logLine(`ã€ç”Ÿæ´»è´¹ã€‘å½“æœˆç¬¬1å‘¨ï¼šå®¶é‡Œæ‰“æ¥ ${g} å…ƒï¼ˆ${before}â†’${state.money}ï¼‰ã€‚`);
    applyMonthlyFixedCosts();
    checkBankruptcyLock();
  }
}

/* ========== é€‰æ‹©å­¦é™¢ï¼šè°ƒç”¨ course.js ========== */
function setAcademy(academy) {
  state.academy = academy;
  state.academyNormalized =
    academy === "ç†å·¥" ? "stem" :
      academy === "å•†ç§‘" ? "biz" :
        academy === "åŒ»å­¦" ? "medicine" :
          "arts";

  if (!window.COURSE || typeof window.COURSE.generatePlan !== "function") {
    logLine("âŒ course.js æœªåŠ è½½ï¼šwindow.COURSE.generatePlan ä¸å­˜åœ¨ã€‚");
    return;
  }

  state.curriculumPlan = window.COURSE.generatePlan(academy);
  state.graduationCreditsRequired = state.curriculumPlan.graduateCredits;
  state.allCoursesPool = state.curriculumPlan.coursePool.slice();

  setText(ui.planPreview, `åŸ¹å…»æ–¹æ¡ˆï¼šæ¯•ä¸šå­¦åˆ† ${state.graduationCreditsRequired}ï¼Œè¯¾ç¨‹æ±  ${state.allCoursesPool.length} é—¨ã€‚`);
  logLine(`ä½ é€‰æ‹©äº†å­¦é™¢ï¼š${academy}ã€‚åŸ¹å…»æ–¹æ¡ˆå·²ç”Ÿæˆã€‚`);
  render();
}
if (ui.btnAcadArts) ui.btnAcadArts.addEventListener("click", () => setAcademy("æ–‡ç§‘/ç¤¾ç§‘"));
if (ui.btnAcadBiz) ui.btnAcadBiz.addEventListener("click", () => setAcademy("å•†ç§‘"));
if (ui.btnAcadSci) ui.btnAcadSci.addEventListener("click", () => setAcademy("ç†å·¥"));
if (ui.btnAcadMed) ui.btnAcadMed.addEventListener("click", () => setAcademy("åŒ»å­¦"));

/* ========== é€‰æ‹©å®¶å¢ƒï¼ˆå¼€å±€é”æ­» + å‘ä¸€æ¬¡å¼€å±€ç”Ÿæ´»è´¹ï¼‰ ========== */
function setFamilyTier(tier) {
  if (state.familyLocked) { logLine("ã€å®¶å¢ƒã€‘å¼€å±€é€‰æ‹©åä¸èƒ½æ›´æ”¹ã€‚"); return; }
  if (!state.academy) { logLine("ã€æç¤ºã€‘å…ˆé€‰å­¦é™¢ï¼Œå†é€‰å®¶å¢ƒã€‚"); return; }

  state.familyTier = tier;
  state.familyMonthlyAllowance = FAMILY_ALLOWANCE_MONTHLY[tier] ?? 800;
  state.familyLocked = true;

  const before = state.money;
  state.money += state.familyMonthlyAllowance;
  logLine(`ä½ é€‰æ‹©äº†å®¶å¢ƒï¼š${tierName(tier)}ã€‚å¼€å±€å®¶é‡Œæ‰“æ¥ ${state.familyMonthlyAllowance} å…ƒï¼ˆ${before}â†’${state.money}ï¼‰ã€‚`);

  checkBankruptcyLock();
  ensureWeeklyEvent();
  render();
}
if (ui.btnTierPoor) ui.btnTierPoor.addEventListener("click", () => setFamilyTier("poor"));
if (ui.btnTierOk) ui.btnTierOk.addEventListener("click", () => setFamilyTier("ok"));
if (ui.btnTierMid) ui.btnTierMid.addEventListener("click", () => setFamilyTier("mid"));
if (ui.btnTierRich) ui.btnTierRich.addEventListener("click", () => setFamilyTier("rich"));

/* ========== Modal å¼€å…³ ========== */
function openModal(el) {
  [ui.modalCourse, ui.modalAddDrop, ui.modalExam, ui.modalEvent].forEach(m => {
    if (!m) return;
    m.classList.add("hidden");
    m.style.display = "none";
  });
  if (!el) return;
  el.classList.remove("hidden");
  el.style.display = "flex";
}
function closeModal(el) {
  if (!el) return;
  el.classList.add("hidden");
  el.style.display = "none";
}
if (ui.btnCloseCourse) ui.btnCloseCourse.addEventListener("click", () => closeModal(ui.modalCourse));
if (ui.btnCloseAdjust) ui.btnCloseAdjust.addEventListener("click", () => closeModal(ui.modalAddDrop));
if (ui.btnCloseExam) ui.btnCloseExam.addEventListener("click", () => closeModal(ui.modalExam));

/* ========== é€‰è¯¾/å†²çª/è€ƒè¯• ========= */
function creditTargetRangeForThisTerm() {
  const idx = termIndex1to8();
  const plan = state.curriculumPlan;
  const target = plan?.termTargetCredits?.[idx - 1] ?? 20;
  // å…è®¸ä¸Šä¸‹æµ®åŠ¨ä¸€ç‚¹
  return { min: Math.max(12, target - 2), max: Math.min(24, target + 2), target };
}

function eligibleCoursesForThisTerm() {
  // è¿™é‡Œâ€œå¯é€‰è¯¾â€ = å…¨æ± ï¼ˆä½ ä¹Ÿå¯ä»¥åŠ å…ˆä¿®ã€å¹´çº§é™åˆ¶ç­‰ï¼‰
  // ä¸ºäº†è®©æ¨¡æ‹Ÿæ›´é¡ºæ»‘ï¼šå…è®¸æå‰1å¹´é€‰ä¸€äº›é€‰ä¿®
  const maxYear = Math.min(4, state.year + 1);
  return state.allCoursesPool.filter(c => (c.yearSuggest ?? 1) <= maxYear);
}

function calcSelectedCredits(list) {
  return list.reduce((s, c) => s + (c.credits || 0), 0);
}

function findScheduleConflicts(courses) {
  const map = new Map();
  for (const c of courses) {
    for (const t of (c.timeslots || [])) {
      if (!map.has(t)) map.set(t, []);
      map.get(t).push(c);
    }
  }
  const conflicts = [];
  for (const [slot, arr] of map.entries()) if (arr.length > 1) conflicts.push({ slot, courses: arr });
  return conflicts;
}

function willConflict(selected, courseToAdd) {
  const taken = new Set();
  for (const c of selected) for (const t of (c.timeslots || [])) taken.add(t);
  for (const t of (courseToAdd.timeslots || [])) if (taken.has(t)) return true;
  return false;
}

function renderConflictPanel() {
  if (!ui.conflictBox) return;
  const conflicts = findScheduleConflicts(state.coursesThisTerm);
  if (conflicts.length === 0) {
    setHTML(ui.conflictBox, `<div class="muted">æš‚æ— ä¸Šè¯¾æ—¶é—´å†²çª âœ…</div>`);
    return;
  }
  const html = conflicts.map(c => {
    const names = c.courses.map(x => x.name).join(" / ");
    return `<div class="conflictItem">â›” ${c.slot}ï¼š${names}</div>`;
  }).join("");
  setHTML(ui.conflictBox, html);
}

function scheduleExamsForTerm() {
  const used = new Map();
  state.examSchedule = {};
  for (const c of state.coursesThisTerm) {
    let day, slot, key, guard = 0;
    do {
      day = rndInt(1, 8);
      slot = rndInt(1, 3);
      key = `${day}-${slot}`;
      guard++;
      if (guard > 25) break;
    } while (used.has(key) && chance(0.75));
    used.set(key, c.id);
    state.examSchedule[c.id] = { day, slot };
  }

  const map = new Map();
  for (const c of state.coursesThisTerm) {
    const ex = state.examSchedule[c.id];
    const k = `${ex.day}-${ex.slot}`;
    if (!map.has(k)) map.set(k, []);
    map.get(k).push(c);
  }
  state.examConflicts = [];
  for (const [k, arr] of map.entries()) if (arr.length > 1) state.examConflicts.push({ key: k, courses: arr });
}

function renderCourseSummary() {
  if (!ui.courseSummary) return;
  if (!state.hasPickedWeek1) { setText(ui.courseSummary, "å°šæœªé€‰è¯¾ã€‚"); return; }
  const credits = state.termCredits;
  const names = state.coursesThisTerm.map(c => c.name).slice(0, 6).join("ã€");
  const more = state.coursesThisTerm.length > 6 ? ` ç­‰${state.coursesThisTerm.length}é—¨` : "";
  setText(ui.courseSummary, `å·²é€‰è¯¾ï¼š${credits} å­¦åˆ†ï½œ${names}${more}`);
}

/* ========== å¼ºåˆ¶è¯¾ï¼šæŒ‰å­¦æœŸé”æ­»åŠ å…¥ï¼ˆä¸èƒ½æ”¹ï¼‰ ========== */
function lockedCourseIdsForCurrentTerm() {
  const idx = termIndex1to8();
  const ids = state.curriculumPlan?.lockedByTerm?.[idx - 1] || [];
  return new Set(ids);
}

function getCourseById(id) {
  return state.allCoursesPool.find(x => x.id === id) || null;
}

/* ========== ç¬¬1å‘¨é€‰è¯¾ï¼ˆæŒ‰åŸ¹å…»æ–¹æ¡ˆè‡ªåŠ¨ + æ— å†²çªï¼‰ ========== */
function openCoursePicker() {
  if (!isReadyToPlay()) return;
  if (state.week !== 1) { logLine("ã€é€‰è¯¾ã€‘åªæœ‰ç¬¬1å‘¨èƒ½è¿›è¡Œé¦–æ¬¡é€‰è¯¾ã€‚"); return; }
  if (state.hasPickedWeek1) { logLine("ã€é€‰è¯¾ã€‘ç¬¬1å‘¨å·²ç»é€‰è¿‡è¯¾ã€‚ç¬¬3å‘¨å¯é€€è¡¥é€‰ã€‚"); return; }

  const pool = eligibleCoursesForThisTerm();
  const lockedIds = lockedCourseIdsForCurrentTerm();
  const temp = new Set();

  // å…ˆæŠŠé”æ­»è¯¾å¡è¿›å»
  for (const id of lockedIds) temp.add(id);

  function autoPickByPlan() {
    temp.clear();
    for (const id of lockedIds) temp.add(id);

    const { target, min, max } = creditTargetRangeForThisTerm();
    const selected = () => pool.filter(c => temp.has(c.id));
    let credits = calcSelectedCredits(selected());

    // ä¼˜å…ˆï¼šæœ¬å­¦é™¢ major requiredï¼Œå† electives
    const majors = pool
      .filter(c => (c.tags || []).includes("major"))
      .sort((a, b) => (Number(a.difficulty ?? 3) - Number(b.difficulty ?? 3)));

    const electives = pool
      .filter(c => (c.tags || []).includes("elective"))
      .sort((a, b) => (Number(a.difficulty ?? 3) - Number(b.difficulty ?? 3)));

    function tryAddCourse(course) {
      if (!course) return false;
      if (temp.has(course.id)) return false;
      const sel = selected();
      if (willConflict(sel, course)) return false;
      temp.add(course.id);
      return true;
    }

    // å…ˆæŠŠ major é‡Œ required çš„å°½é‡å¡ï¼ˆä¸å†²çªï¼‰
    for (const c of majors) {
      if (!c.required) continue;
      if (credits >= target) break;
      if (tryAddCourse(c)) credits = calcSelectedCredits(selected());
    }

    // å†è¡¥ electives
    for (const c of electives) {
      if (credits >= target) break;
      if (tryAddCourse(c)) credits = calcSelectedCredits(selected());
    }

    // å¦‚æœè¿˜æ²¡åˆ° minï¼Œå°±ç»§ç»­ä» majors éå¿…ä¿®é‡ŒæŒ‘
    for (const c of majors) {
      if (credits >= min) break;
      if (tryAddCourse(c)) credits = calcSelectedCredits(selected());
    }

    // ä¸Šé™ä¿æŠ¤
    if (credits > max) {
      // è¶…äº†å°±ä¸å†åŠ ï¼›ï¼ˆè¿™é‡Œä¸åšè‡ªåŠ¨åˆ è¯¾ï¼Œé¿å…â€œæˆ‘æ›¿ä½ å†³å®šâ€ï¼‰
    }
    rerenderList();
  }

  function rerenderList() {
    if (!ui.courseList) return;
    const selected = pool.filter(c => temp.has(c.id));
    const credits = calcSelectedCredits(selected);
    const { min, max, target } = creditTargetRangeForThisTerm();

    if (ui.selectedInfo) setText(ui.selectedInfo, `å·²é€‰ï¼š${selected.length} é—¨ / ${credits} å­¦åˆ†ï¼ˆç›®æ ‡â‰ˆ${target}ï¼‰`);
    if (ui.modalCourseHint) setText(ui.modalCourseHint, `å»ºè®®å­¦åˆ†ï¼š${min}-${max}ï¼ˆå¼ºåˆ¶è¯¾å·²é”æ­»è‡ªåŠ¨åŠ å…¥ï¼›é€‰è¯¾è¿‡ç¨‹ä¸­ç¦æ­¢æ—¶é—´å†²çªï¼‰`);

    // æ¸²æŸ“åˆ—è¡¨ï¼šé”æ­»è¯¾ä¸å¯ç‚¹
    setHTML(ui.courseList, pool.map(c => {
      const checked = temp.has(c.id);
      const req = c.required ? "å¿…ä¿®" : "é€‰ä¿®";
      const slots = (c.timeslots || []).join(",");
      const locked = c.locked || lockedIds.has(c.id);
      const cls = `courseRow ${checked ? "selected" : ""} ${locked ? "locked" : ""}`;
      return `
        <div class="${cls}" data-id="${c.id}">
          <div class="courseMain">
            <div class="courseName">${c.name} <span class="muted">(${req}ï½œ${c.credits}å­¦åˆ†ï½œéš¾åº¦${c.difficulty})</span></div>
            <div class="muted">ä¸Šè¯¾æ—¶é—´ï¼š${slots}${locked ? " ï½œğŸ”’é”æ­»" : ""}</div>
          </div>
          <div class="courseToggle">${checked ? "âœ…" : "ï¼‹"}</div>
        </div>
      `;
    }).join(""));

    Array.from(ui.courseList.querySelectorAll(".courseRow")).forEach(row => {
      row.addEventListener("click", () => {
        const id = row.getAttribute("data-id");
        if (!id) return;

        const course = pool.find(x => x.id === id);
        if (!course) return;

        // é”æ­»è¯¾ä¸å¯æ”¹
        if (course.locked || lockedIds.has(id)) return;

        if (temp.has(id)) {
          temp.delete(id);
        } else {
          // âœ… ç¦æ­¢æ—¶é—´å†²çª
          const sel = pool.filter(x => temp.has(x.id));
          if (willConflict(sel, course)) {
            logLine(`ã€é€‰è¯¾å¤±è´¥ã€‘ã€Œ${course.name}ã€ä¸å·²é€‰è¯¾ç¨‹æ—¶é—´å†²çªï¼Œä¸èƒ½é€‰ã€‚`);
            return;
          }
          temp.add(id);
        }
        rerenderList();
      });
    });
  }

  function confirmPick() {
    const selected = pool.filter(c => temp.has(c.id));
    const credits = calcSelectedCredits(selected);
    const { min } = creditTargetRangeForThisTerm();

    // å¿…é¡»æ— å†²çª
    const conf = findScheduleConflicts(selected);
    if (conf.length > 0) { logLine(`ã€é€‰è¯¾å¤±è´¥ã€‘æ£€æµ‹åˆ°ä¸Šè¯¾æ—¶é—´å†²çª ${conf.length} å¤„ï¼Œè¯·å…ˆåˆ æ‰å†²çªè¯¾ã€‚`); return; }
    if (credits < min) { logLine(`ã€é€‰è¯¾å¤±è´¥ã€‘å­¦åˆ†å¤ªå°‘ï¼š${credits}ï¼ˆè‡³å°‘${min}ï¼‰ã€‚`); return; }

    state.coursesThisTerm = selected;
    state.termCredits = credits;
    state.hasPickedWeek1 = true;
    state.conflictsResolved = true; // âœ… é€‰è¯¾æ—¶å·²ç¦æ­¢å†²çª

    // é‡ç½®å­¦ä¹ åˆ†é…
    state.totalStudyThisTerm = 0;
    state.finalsStudyWeeksThisTerm = 0;
    state.termGradeBonus = 0;
    state.studyActionsByCourseId = {};
    state.masteredCourseIds = [];
    state.cetPrepThisTerm = 0;

    scheduleExamsForTerm();
    renderConflictPanel();
    renderCourseSummary();

    logLine(`ã€é€‰è¯¾å®Œæˆã€‘æœ¬å­¦æœŸå·²é€‰ ${selected.length} é—¨è¯¾ï¼Œå…± ${credits} å­¦åˆ†ï¼ˆæ— æ—¶é—´å†²çªï¼‰ã€‚`);
    closeModal(ui.modalCourse);
    render();
  }

  if (ui.btnAutoPick) ui.btnAutoPick.onclick = autoPickByPlan;
  if (ui.btnConfirmPick) ui.btnConfirmPick.onclick = confirmPick;

  rerenderList();
  openModal(ui.modalCourse);
}
if (ui.btnOpenCoursePicker) ui.btnOpenCoursePicker.addEventListener("click", openCoursePicker);

function autoPlanThisTerm() {
  if (!isReadyToPlay()) return;
  if (!state.curriculumPlan) { logLine("ã€è‡ªåŠ¨é€‰è¯¾ã€‘å°šæœªç”ŸæˆåŸ¹å…»æ–¹æ¡ˆï¼šå…ˆé€‰å­¦é™¢ã€‚"); return; }
  if (state.week !== 1) { logLine("ã€è‡ªåŠ¨é€‰è¯¾ã€‘ä»…ç¬¬1å‘¨å¯è¿›è¡Œé¦–æ¬¡è‡ªåŠ¨é€‰è¯¾ï¼ˆå¦åˆ™å¯åœ¨ç¬¬3å‘¨é€€è¡¥é€‰ï¼‰ã€‚"); return; }

  const idx = termIndex1to8();
  const list = state.curriculumPlan?.plan?.[idx] || [];
  // filter out completed
  const selected = list.filter(c => !state.completedCourseIds?.has(c.id));
  state.coursesThisTerm = selected.map(c => ({ ...c }));
  state.termCredits = calcSelectedCredits(state.coursesThisTerm);
  state.hasPickedWeek1 = true;
  state.conflictsResolved = (findScheduleConflicts(state.coursesThisTerm).length === 0);
  scheduleExamsForTerm();
  renderConflictPanel();
  renderCourseSummary();
  logLine(`âœ…ã€è‡ªåŠ¨é€‰è¯¾ã€‘æŒ‰åŸ¹å…»æ–¹æ¡ˆä¸ºç¬¬${idx}å­¦æœŸé€‰è¯¾ï¼šå…± ${state.coursesThisTerm.length} é—¨ / ${state.termCredits} å­¦åˆ†ï¼ˆå¼ºåˆ¶è¯¾å·²é”æ­»ï¼‰`);
  render();
}
if (ui.btnAutoPlan) ui.btnAutoPlan.addEventListener("click", autoPlanThisTerm);

/* ========== ç¬¬3å‘¨é€€è¡¥é€‰ï¼šè¡¥é€‰ + é€€è¯¾ + å¿…é¡»æ— å†²çªæ‰èƒ½ç¡®è®¤ï¼ˆå¼¹çª—ï¼‰ ========== */
function openAdjust(autoOpened = false) {
  if (!isReadyToPlay()) return;
  if (!state.hasPickedWeek1) { logLine("ã€é€€è¡¥é€‰ã€‘å…ˆåœ¨ç¬¬1å‘¨é€‰è¯¾ã€‚"); return; }
  if (state.week !== 3) { logLine("ã€é€€è¡¥é€‰ã€‘åªæœ‰ç¬¬3å‘¨å¼€æ”¾é€€è¡¥é€‰ã€‚"); return; }

  const pool = eligibleCoursesForThisTerm();
  const lockedIds = lockedCourseIdsForCurrentTerm();
  const temp = new Set(state.coursesThisTerm.map(c => c.id));
  for (const id of lockedIds) temp.add(id);

  function selectedList() { return pool.filter(c => temp.has(c.id)); }

  function rerender() {
    if (!ui.adCurrent || !ui.adPool) return;

    const selected = selectedList();
    const credits = calcSelectedCredits(selected);
    const conflicts = findScheduleConflicts(selected);

    const { min, max, target } = creditTargetRangeForThisTerm();

    const confHtml = conflicts.length
      ? `<div class="muted">âš ï¸ å½“å‰ä»æœ‰å†²çªï¼š${conflicts.map(x => `${x.slot}(${x.courses.map(c => c.name).join("/")})`).join("ï¼›")}</div>`
      : `<div class="muted">æš‚æ— å†²çª âœ…</div>`;

    // å½“å‰å·²é€‰ï¼ˆå·¦ä¾§ï¼‰
    const curRows = selected.map(course => {
      const locked = course.locked || lockedIds.has(course.id);
      const slots = (course.timeslots || []).join(",");
      return `
        <div class="courseRow ${locked ? 'locked' : ''}" data-id="${course.id}">
          <div class="courseMain">
            <div class="courseName">${course.name} <span class="muted">(${course.credits}å­¦åˆ†)</span></div>
            <div class="muted">ä¸Šè¯¾æ—¶é—´ï¼š${slots}${locked ? ' ï½œğŸ”’é”æ­»' : ''}</div>
          </div>
          <div class="courseToggle">${locked ? 'ğŸ”’' : 'ï¼'}</div>
        </div>
      `;
    }).join("");

    setHTML(ui.adCurrent, `
      <div class="panel">
        <div style="font-weight:900;">æœ¬å­¦æœŸç›®æ ‡ï¼šâ‰ˆ${target} å­¦åˆ†ï¼ˆå»ºè®® ${min}-${max}ï¼‰</div>
        <div class="muted">å½“å‰å·²é€‰ï¼š${selected.length} é—¨ / ${credits} å­¦åˆ†</div>
        ${confHtml}
      </div>
      <div class="divider"></div>
      <div>${curRows}</div>
    `);

    // å¯é€‰æ± ï¼ˆå³ä¾§ï¼‰
    const rows = pool.map(course => {
      const checked = temp.has(course.id);
      const locked = course.locked || lockedIds.has(course.id);
      const slots = (course.timeslots || []).join(",");
      const req = course.required ? "å¿…ä¿®" : "é€‰ä¿®";
      const cls = `courseRow ${checked ? "selected" : ""} ${locked ? "locked" : ""}`;
      return `
        <div class="${cls}" data-id="${course.id}">
          <div class="courseMain">
            <div class="courseName">${course.name} <span class="muted">(${req}ï½œ${course.credits}å­¦åˆ†)</span></div>
            <div class="muted">ä¸Šè¯¾æ—¶é—´ï¼š${slots}${locked ? " ï½œğŸ”’é”æ­»" : ""}</div>
          </div>
          <div class="courseToggle">${checked ? "âœ…" : "ï¼‹"}</div>
        </div>
      `;
    }).join("");

    setHTML(ui.adPool, `<div>${rows}</div>`);

    // äº¤äº’ç»‘å®š
    Array.from(ui.adPool.querySelectorAll(".courseRow")).forEach(row => {
      row.addEventListener("click", () => {
        const id = row.getAttribute("data-id");
        if (!id) return;

        const course = pool.find(x => x.id === id);
        if (!course) return;

        if (course.locked || lockedIds.has(id)) return;

        if (temp.has(id)) temp.delete(id);
        else {
          const sel = selectedList();
          if (willConflict(sel, course)) {
            logLine(`ã€è¡¥é€‰å¤±è´¥ã€‘ã€Œ${course.name}ã€ä¸å·²é€‰è¯¾ç¨‹æ—¶é—´å†²çªï¼Œä¸èƒ½é€‰ã€‚`);
            return;
          }
          temp.add(id);
        }
        rerender();
      });
    });

    Array.from(ui.adCurrent.querySelectorAll(".courseRow")).forEach(row => {
      row.addEventListener("click", () => {
        const id = row.getAttribute("data-id");
        if (!id) return;
        const course = pool.find(x => x.id === id) || state.coursesThisTerm.find(x=>x.id===id);
        if (!course) return;
        if (course.locked || lockedIds.has(id)) return;
        if (temp.has(id)) temp.delete(id); else temp.add(id);
        rerender();
      });
    });
  }

  function confirmAdjust() {
    const selected = selectedList();
    const credits = calcSelectedCredits(selected);
    const { min } = creditTargetRangeForThisTerm();

    const conf = findScheduleConflicts(selected);
    if (conf.length > 0) { logLine(`ã€é€€è¡¥é€‰å¤±è´¥ã€‘ä»æœ‰ ${conf.length} å¤„ä¸Šè¯¾æ—¶é—´å†²çªï¼šå¿…é¡»æ¸…é›¶æ‰èƒ½ç¡®è®¤ã€‚`); rerender(); return; }
    if (credits < min) { logLine(`ã€é€€è¡¥é€‰å¤±è´¥ã€‘å­¦åˆ†å¤ªå°‘ï¼š${credits}ï¼ˆè‡³å°‘${min}ï¼‰ã€‚`); rerender(); return; }

    state.coursesThisTerm = selected;
    state.termCredits = credits;
    state.hasAdjustedWeek3 = true;
    state.conflictsResolved = true;

    scheduleExamsForTerm();
    renderConflictPanel();
    renderCourseSummary();

    logLine(`ã€é€€è¡¥é€‰å®Œæˆã€‘ç°åœ¨ ${state.coursesThisTerm.length} é—¨ / ${state.termCredits} å­¦åˆ†ï¼ˆæ— æ—¶é—´å†²çªï¼‰ã€‚`);
    closeModal(ui.modalAdjust);
    render();
  }

  if (ui.btnCloseAddDrop) ui.btnCloseAddDrop.onclick = confirmAdjust;

  function autoResolve() {
    let removed = 0;
    let conflicts = findScheduleConflicts(selectedList());
    while (conflicts.length > 0 && removed < 50) {
      for (const g of conflicts) {
        const candidate = g.courses
          .filter(c => !(c.locked || lockedIds.has(c.id)))
          .sort((a,b)=> b.difficulty - a.difficulty)[0];
        if (candidate) { temp.delete(candidate.id); removed++; }
        else { logLine("ã€è‡ªåŠ¨æ’å†²çªã€‘å­˜åœ¨é”æ­»è¯¾ï¼Œæ— æ³•å®Œå…¨è‡ªåŠ¨æ¸…é™¤ï¼Œè¯·æ‰‹åŠ¨è°ƒæ•´ã€‚"); }
      }
      conflicts = findScheduleConflicts(selectedList());
    }
    rerender();
    if (removed>0) logLine(`ã€è‡ªåŠ¨æ’å†²çªã€‘å°è¯•ç§»é™¤ ${removed} é—¨è¯¾ç¨‹ä»¥æ¶ˆé™¤å†²çªã€‚`);
  }

  if (ui.btnResolveConflicts) ui.btnResolveConflicts.onclick = autoResolve;

  rerender();
  openModal(ui.modalAddDrop);

  if (autoOpened) logLine("ğŸ“Œã€æé†’ã€‘ç¬¬3å‘¨å¼€æ”¾é€€è¡¥é€‰ï¼šä½ å¯ä»¥è¡¥é€‰æ›´å¤šè¯¾ï¼Œç›´åˆ°è¯¾è¡¨æ— å†²çªã€‚");
}
if (ui.btnOpenAddDrop) ui.btnOpenAddDrop.addEventListener("click", () => openAdjust(false));

function openExamView() {
  if (!isReadyToPlay()) return;
  if (!state.hasPickedWeek1) { logLine("ã€è€ƒè¯•æ’æœŸã€‘å…ˆé€‰è¯¾ã€‚"); return; }
  if (!ui.examBody) return;

  const rows = state.coursesThisTerm.map(c => {
    const ex = state.examSchedule[c.id] || { day: "-", slot: "-" };
    return `
      <tr>
        <td style="padding:8px;">${c.name}</td>
        <td style="padding:8px;text-align:center;">Day ${ex.day}</td>
        <td style="padding:8px;text-align:center;">Slot ${ex.slot}</td>
      </tr>
    `;
  }).join("");

  setHTML(ui.examBody, `
    <table class="table" style="width:100%;border-collapse:collapse;">
      <thead>
        <tr>
          <th style="text-align:left;padding:8px;">è¯¾ç¨‹</th>
          <th style="padding:8px;">è€ƒè¯•æ—¥</th>
          <th style="padding:8px;">åœºæ¬¡</th>
        </tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>
    <div class="muted" style="margin-top:10px;">
      ${state.examConflicts.length ? "âš ï¸ æœ‰è€ƒè¯•å†²çªï¼ˆæ›´çœŸå®ï¼‰" : "æš‚æ— è€ƒè¯•å†²çª âœ…"}
    </div>
  `);

  openModal(ui.modalExam);
}
if (ui.btnOpenExamView) ui.btnOpenExamView.addEventListener("click", openExamView);

/* ========== è¡ŒåŠ¨é¢æ¿ï¼ˆåŠ¨æ€æ¸²æŸ“ï¼‰ ========= */
function renderActionPanel() {
  if (!ui.actionPanel) return;
  const actions = [
    { id: 'study', label: 'å­¦ä¹ ', fn: doStudy },
    { id: 'english', label: 'åˆ·è‹±è¯­', fn: doEnglish },
    { id: 'social', label: 'èšä¼š/ç¤¾äº¤', fn: doSocialize },
    { id: 'walk', label: 'æ•£å¿ƒ', fn: doWalk },
    { id: 'eat', label: 'å¤§åƒ', fn: doEat },
    { id: 'parttime', label: 'å…¼èŒ', fn: doPartTime },
    { id: 'travel', label: 'æ—…æ¸¸', fn: doTravel },
    { id: 'research', label: 'åšç§‘ç ”', fn: doResearch },
    { id: 'intern', label: 'å®ä¹ ', fn: doIntern },
    { id: 'retake', label: 'é‡ä¿®', fn: doRetake }
  ];

  ui.actionPanel.innerHTML = '';
  const block = !isReadyToPlaySilent() || state.isBankruptLocked || state.eventPending;

  for (const a of actions) {
    const b = document.createElement('button');
    b.className = 'btn';
    b.textContent = a.label;
    b.dataset.action = a.id;
    b.onclick = () => { a.fn(); };
    // action-specific disables
    if (a.id === 'study' && (state.energy <= 0 || state.stress >= 80)) b.disabled = true;
    if (a.id === 'retake' && state.primaryGrades && Object.keys(state.primaryGrades).length === 0) b.disabled = true;
    if (a.id === 'english' && state.week !== 1 && state.week !== 2 && state.week !== 3 && state.week !== 4) {
      // allow english most weeks but you can tweak
    }
    ui.actionPanel.appendChild(b);
  }

  if (ui.actionsLeft) setText(ui.actionsLeft, state.actionsLeft);
}

/* ========== äº‹ä»¶ç³»ç»Ÿ ========= */
function getAllEvents() {
  return Array.isArray(window.EVENTS) ? window.EVENTS : [];
}
function tickEventCooldowns() {
  for (const k of Object.keys(state.eventCooldown)) {
    state.eventCooldown[k] -= 1;
    if (state.eventCooldown[k] <= 0) delete state.eventCooldown[k];
  }
}
function weightedShuffle(events) {
  const bag = [];
  for (const ev of events) {
    const w = Math.max(1, Math.min(50, Number(ev.weight || 1)));
    for (let i = 0; i < w; i++) bag.push(ev);
  }
  for (let i = bag.length - 1; i > 0; i--) {
    const j = rndInt(0, i);
    [bag[i], bag[j]] = [bag[j], bag[i]];
  }
  const seen = new Set();
  const out = [];
  for (const ev of bag) {
    if (seen.has(ev.id)) continue;
    seen.add(ev.id);
    out.push(ev);
  }
  return out;
}

function buildEventPool() {
  const all = getAllEvents();
  const pool = [];
  const matchFn = (typeof window.eventMatchesState === "function") ? window.eventMatchesState : null;

  for (const ev of all) {
    if (!ev?.id) continue;
    if (state.eventCooldown[ev.id]) continue;
    if (state.recentEventIds.includes(ev.id)) continue;
    if (matchFn && !matchFn(ev, state)) continue;
    pool.push(ev);
  }

  // è½¨è¿¹äº‹ä»¶ï¼šç¤¾äº¤è¶Šé«˜æƒé‡è¶Šé«˜ï¼ˆä½ è¦æ±‚ï¼‰
  for (const ev of pool) {
    const tags = ev.tags || [];
    if (tags.includes("breakthrough")) {
      const s = clamp(state.social ?? 50, 0, 100);
      // 50->ä¸å˜ï¼›80->+2ï¼›95->+4
      const bump = (s >= 95) ? 4 : (s >= 80) ? 2 : 0;
      ev.weight = (ev.weight || 1) + bump;
    }
  }

  // å¦‚æœå¤ªå°‘ï¼Œæ”¾å®½ recent é™åˆ¶ï¼ˆä¿åº•ï¼‰
  if (pool.length < 8) {
    for (const ev of all) {
      if (!ev?.id) continue;
      if (state.eventCooldown[ev.id]) continue;
      if (matchFn && !matchFn(ev, state)) continue;
      pool.push(ev);
    }
  }

  return pool;
}

function emergencyPick() {
  const variants = [
    {
      id: "EMERGENCY_A",
      title: "å¹³æ·¡ä½†çœŸå®çš„ä¸€å‘¨",
      text: "äº‹ä»¶åº“æœªå°±ç»ªï¼Œä½†ç”Ÿæ´»ä»è¦ç»§ç»­ã€‚",
      options: [
        { text: "ç¨³ç¨³å­¦ä¹ ", effects: { energy: -6, stress: +3, termGradeBonus: +1, hidden: { academicPower: +0.4 }, note: "ä½ åœ¨ä¸ç¡®å®šä¸­æ¨è¿›ã€‚" } },
        { text: "è®¤çœŸä¼‘æ¯", effects: { energy: +7, stress: -5, mood: +3, hidden: { stability: +1 }, note: "ä½ å…ˆæŠŠè‡ªå·±ç…§é¡¾å¥½ã€‚" } }
      ]
    }
  ];
  return variants[rndInt(0, variants.length - 1)];
}

function refillDeckIfNeeded() {
  if (state.eventDeck.length > 0) return;

  const pool = buildEventPool();
  if (pool.length === 0) {
    logLine("âš ï¸ã€äº‹ä»¶ã€‘EVENTS ä¸ºç©ºæˆ–è¢« gates è¿‡æ»¤ï¼šä½¿ç”¨ä¿åº•äº‹ä»¶ï¼ˆæ£€æŸ¥è„šæœ¬é¡ºåºï¼‰ã€‚");
    state.eventDeck = [emergencyPick(), emergencyPick(), emergencyPick()];
    return;
  }

  state.eventDeck = weightedShuffle(pool);
}

function ensureWeeklyEvent() {
  if (!isReadyToPlaySilent()) return;
  if (state.currentEvent && state.eventPending) return;

  refillDeckIfNeeded();
  const ev = state.eventDeck.shift() || emergencyPick();

  state.currentEvent = ev;
  state.eventPending = true;
  renderEventCard();
}

/* ========== applyEffectsï¼šåŠ å…¥ social + mood æŠ˜æ‰£ ========= */
function applyEffects(effects) {
  if (!effects) return;

  if (typeof effects.energy === "number") state.energy = clamp(state.energy + effects.energy, 0, 100);
  if (typeof effects.stress === "number") state.stress = clamp(state.stress + effects.stress, 0, 100);

  if (typeof effects.mood === "number") {
    // âœ… è´Ÿé¢å¿ƒæƒ…ä¸‹é™æ‰“æŠ˜
    applyMoodDelta(effects.mood);
  }

  if (typeof effects.money === "number") state.money = Math.max(0, state.money + effects.money);

  // âœ… ç¤¾äº¤
  if (typeof effects.social === "number") state.social = clamp(state.social + effects.social, 0, 100);

  if (typeof effects.termGradeBonus === "number") {
    state.termGradeBonus = clamp(state.termGradeBonus + effects.termGradeBonus, -5, 5);
  }

  const h = effects.hidden;
  if (h && typeof h === "object") {
    if (typeof h.academicPower === "number") hiddenProfile.academicPower += h.academicPower;
    if (typeof h.researchPower === "number") hiddenProfile.researchPower += h.researchPower;
    if (typeof h.careerPower === "number") hiddenProfile.careerPower += h.careerPower;
    if (typeof h.englishPower === "number") hiddenProfile.englishPower += h.englishPower;
    if (typeof h.stability === "number") hiddenProfile.stability += h.stability;
    if (typeof h.luck === "number") hiddenProfile.luck += h.luck;
  }

  if (effects.flags && typeof effects.flags === "object") {
    state.flags = state.flags || {};
    for (const [k, v] of Object.entries(effects.flags)) state.flags[k] = !!v;
  }

  checkBankruptcyLock();
}

/* ========== äº‹ä»¶æ—¥å¿—ï¼šæ‰“å°æ•°å€¼å˜åŒ– ========= */
const STAT_LABELS = {
  energy: "ç²¾åŠ›",
  stress: "å‹åŠ›",
  mood: "å¿ƒæƒ…",
  social: "ç¤¾äº¤",
  money: "é‡‘é’±",
  termGradeBonus: "æˆç»©ä¿®æ­£"
};
const HIDDEN_LABELS = {
  academicPower: "å­¦æœ¯æ½œåŠ›",
  researchPower: "ç§‘ç ”æ½œåŠ›",
  careerPower: "å°±ä¸šæ½œåŠ›",
  englishPower: "è‹±è¯­æ½œåŠ›",
  stability: "ç¨³å®šæ€§",
  luck: "å¹¸è¿"
};

function snapshotForEventLog() {
  return {
    energy: state.energy,
    stress: state.stress,
    mood: state.mood,
    social: state.social,
    money: state.money,
    termGradeBonus: state.termGradeBonus,
    hidden: { ...hiddenProfile }
  };
}
function diffSnapshot(a, b) {
  const diff = { stats: {}, hidden: {} };

  for (const k of Object.keys(STAT_LABELS)) {
    const da = Number(a[k] ?? 0);
    const db = Number(b[k] ?? 0);
    const d = db - da;
    if (Math.abs(d) > 1e-9) diff.stats[k] = d;
  }

  for (const k of Object.keys(HIDDEN_LABELS)) {
    const da = Number(a.hidden?.[k] ?? 0);
    const db = Number(b.hidden?.[k] ?? 0);
    const d = db - da;
    if (Math.abs(d) > 1e-9) diff.hidden[k] = d;
  }

  return diff;
}
function formatDeltaLine(map, labels, digits = 0) {
  const parts = [];
  for (const [k, d] of Object.entries(map)) {
    const sign = d >= 0 ? "+" : "";
    const num = (digits > 0) ? Number(d).toFixed(digits) : String(Math.round(d));
    parts.push(`${labels[k]} ${sign}${num}`);
  }
  return parts.join("ï½œ");
}

function renderEventCard() {
  if (!ui.eventCard || !ui.eventTitle || !ui.eventText || !ui.eventOptions) return;

  if (!state.currentEvent) {
    if (ui.noEventHint) ui.noEventHint.classList.remove("hidden");
    ui.eventCard.classList.add("hidden");
    return;
  }

  if (ui.noEventHint) ui.noEventHint.classList.add("hidden");
  ui.eventCard.classList.remove("hidden");
  ui.eventCard.classList.toggle("done", !state.eventPending);

  setText(ui.eventTitle, state.currentEvent.title || "æœ¬å‘¨äº‹ä»¶");
  setText(ui.eventText, state.currentEvent.text || "");

  ui.eventOptions.innerHTML = "";

  if (!state.eventPending) {
    ui.eventOptions.innerHTML = `<div class="muted doneHint">æœ¬å‘¨äº‹ä»¶å·²å¤„ç† âœ…</div>`;
    return;
  }

  (state.currentEvent.options || []).forEach((opt, idx) => {
    const btn = document.createElement("button");
    btn.className = "eventBtn";
    btn.textContent = opt.text || `é€‰é¡¹${idx + 1}`;

    btn.addEventListener("click", () => {
      const ev = state.currentEvent;

      const merged = Object.assign({}, opt.effects || {});
      if (opt.hidden) merged.hidden = Object.assign({}, merged.hidden || {}, opt.hidden);
      if (opt.flags) merged.flags = Object.assign({}, merged.flags || {}, opt.flags);
      if (opt.note && !merged.note) merged.note = opt.note;

      const beforeSnap = snapshotForEventLog();
      applyEffects(merged);

      const afterSnap = snapshotForEventLog();
      const delta = diffSnapshot(beforeSnap, afterSnap);

      const cd = Number(ev.cooldownWeeks ?? ev.cooldown ?? 0);
      if (cd > 0) state.eventCooldown[ev.id] = cd;

      state.recentEventIds.push(ev.id);
      if (state.recentEventIds.length > 10) state.recentEventIds.shift();

      state.eventPending = false;

      logLine(`ã€äº‹ä»¶ã€‘ä½ é€‰æ‹©äº†ï¼š${btn.textContent}`);
      if (merged.note) logLine(`ã€äº‹ä»¶ç»“æœã€‘${merged.note}`);

      const statLine = formatDeltaLine(delta.stats, STAT_LABELS, 0);
      const hiddenLine = formatDeltaLine(delta.hidden, HIDDEN_LABELS, 1);

      if (statLine) logLine(`ã€æ•°å€¼å˜åŒ–ã€‘${statLine}`);
      if (hiddenLine) logLine(`ã€æš—çº¿å˜åŒ–ã€‘${hiddenLine}`);

      logLine(`ï¼ˆå½“å‰ï¼šç²¾åŠ›${state.energy}ï½œå‹åŠ›${state.stress}ï½œå¿ƒæƒ…${state.mood}ï½œç¤¾äº¤${state.social}ï½œé‡‘é’±${state.money}ï½œæˆç»©ä¿®æ­£${state.termGradeBonus >= 0 ? "+" : ""}${state.termGradeBonus}ï¼‰`);

      render();
    });

    ui.eventOptions.appendChild(btn);
  });
}

/* ========== è¡ŒåŠ¨ç³»ç»Ÿ ========== */
function actionBlocked(withLog = true) {
  if (!isReadyToPlay()) return true;
  if (state.isBankruptLocked) return true;

  if (state.eventPending) {
    if (withLog) logLine("ã€æœ¬å‘¨äº‹ä»¶ã€‘å…ˆé€‰æ‹©æœ¬å‘¨äº‹ä»¶ï¼Œæ‰èƒ½è¡ŒåŠ¨ã€‚");
    return true;
  }
  if (state.actionsLeft <= 0) return true;

  if (state.week === 1 && !state.hasPickedWeek1) {
    if (withLog) logLine("ã€æç¤ºã€‘ç¬¬1å‘¨å¿…é¡»å…ˆé€‰è¯¾ï¼ˆå»â€œé€‰è¯¾&è€ƒè¯•â€é¡µï¼‰ã€‚");
    return true;
  }
  return false;
}
function consumeAction() {
  state.actionsLeft -= 1;
  if (state.actionsLeft < 0) state.actionsLeft = 0;
}

/* ========== å­¦ä¹ ï¼šæŒ‰è¯¾ç¨‹åˆ†é…ï¼ˆä¿ç•™ä½ çš„æ€è·¯ï¼‰ ========== */
function getAutoStudyTargetCourses(count = 4) {
  const list = Array.isArray(state.coursesThisTerm) ? state.coursesThisTerm : [];
  if (!list.length) return [];

  const mastered = new Set(state.masteredCourseIds || []);
  const candidates = list.filter(c => !mastered.has(c.id));

  if (candidates.length) {
    candidates.sort((a, b) => {
      const da = Number(a.difficulty ?? 3);
      const db = Number(b.difficulty ?? 3);
      if (da !== db) return da - db;
      const ra = a.required ? 0 : 1;
      const rb = b.required ? 0 : 1;
      if (ra !== rb) return ra - rb;
      return String(a.name).localeCompare(String(b.name));
    });
    return candidates.slice(0, count);
  }

  const all = [...list].sort((a, b) => {
    const sa = Number(state.studyActionsByCourseId?.[a.id] || 0);
    const sb = Number(state.studyActionsByCourseId?.[b.id] || 0);
    if (sa !== sb) return sa - sb;
    const da = Number(a.difficulty ?? 3);
    const db = Number(b.difficulty ?? 3);
    if (da !== db) return db - da;
    return String(a.name).localeCompare(String(b.name));
  });

  return all.slice(0, count);
}

function calcLuckEffective() {
  // âœ… ç¤¾äº¤è¶Šé«˜ï¼Œè¶Šâ€œå¥½è¿â€ï¼ˆä½ è¦æ±‚ï¼‰
  // è¿™é‡ŒæŠŠç¤¾äº¤æ˜ å°„æˆé¢å¤– luckï¼šç¤¾äº¤50->+0ï¼›90->+12ï¼›100->+15
  const s = clamp(state.social ?? 50, 0, 100);
  const add = (s <= 50) ? 0 : (s - 50) * 0.3;
  return clamp(hiddenProfile.luck + add, 0, 100);
}

function doStudy() {
  if (actionBlocked()) return;

  const targets = getAutoStudyTargetCourses(4);
  if (!targets.length) {
    logLine("ã€å­¦ä¹ ã€‘æœ¬å­¦æœŸæ²¡æœ‰è¯¾ç¨‹å¯å­¦ä¹ ï¼ˆå¯èƒ½è¿˜æ²¡é€‰è¯¾ï¼‰ã€‚");
    return;
  }

  const mult = ACADEMY_STUDY_STRESS_MULT[state.academy] ?? 1.0;
  state.energy = clamp(state.energy - 10, 0, 100);
  state.stress = clamp(state.stress + Math.round(9 * mult), 0, 100);
  applyMoodDelta(-2);
  hiddenProfile.academicPower += 0.5;

  state.totalStudyThisTerm += 1;
  if (FINALS_WEEKS.includes(state.week)) state.finalsStudyWeeksThisTerm += 1;

  const explainFn = window.GRADING?.explain;

  targets.forEach((course) => {
    const cid = course.id;
    state.studyActionsByCourseId[cid] = (state.studyActionsByCourseId[cid] || 0) + 1;
    const actions = state.studyActionsByCourseId[cid];

    let predictedScore = null;
    let predictedLevel = null;

    if (typeof explainFn === "function") {
      const detail = explainFn({
        course: course,
        studyActionsForThisCourse: actions,
        totalStudyThisTerm: state.totalStudyThisTerm,
        finalsStudyWeeks: state.finalsStudyWeeksThisTerm,
        termBonus: state.termGradeBonus,
        energy: state.energy,
        stress: state.stress,
        disciplineFlag: state.disciplineFlag,
        conflictsResolved: state.conflictsResolved,
        flags: state.flags || {},
        social: state.social,
        luck: calcLuckEffective()
      });

      predictedScore = Math.round((detail.band.lo + detail.band.hi) / 2);
      predictedLevel =
        window.GRADING?.percentToGradeLevel?.(predictedScore) ||
        detail.band.band ||
        "?";
    }

    const isMasteredA = (predictedScore !== null) && (predictedScore >= 90);
    if (isMasteredA) {
      const wasMastered = (state.masteredCourseIds || []).includes(cid);
      if (!wasMastered) state.masteredCourseIds.push(cid);
      logLine(`å­¦ä¹ ï¼šä½ å•ƒã€Œ${course.name}ã€â†’ é¢„æµ‹ ${predictedScore}ï¼ˆ${predictedLevel}ï¼‰âœ… è¾¾åˆ°A(â‰¥90) ${wasMastered ? "å·©å›º" : "æŒæ¡"}`);
    } else {
      logLine(`å­¦ä¹ ï¼šæŠ•å…¥ã€Œ${course.name}ã€ï½œç¬¬${actions}æ¬¡å–‚è¯¾ â†’ é¢„æµ‹ ${predictedScore ?? "?"}ï¼ˆ${predictedLevel ?? "?"}ï¼‰`);
    }
  });

  consumeAction();
  afterAction();
}

/* ========== æ–°å¢è¡ŒåŠ¨ï¼šåˆ·è‹±è¯­ï¼ˆCET4/6ï¼‰ ========== */
function doEnglish() {
  if (actionBlocked()) return;

  state.energy = clamp(state.energy - 8, 0, 100);
  state.stress = clamp(state.stress + 5, 0, 100);
  applyMoodDelta(-1);

  hiddenProfile.englishPower += 0.8;
  state.cetPrepThisTerm += 1;

  logLine(`åˆ·è‹±è¯­ï¼šè‹±è¯­æ½œåŠ›+ï¼Œæœ¬å­¦æœŸCETå¤‡è€ƒæ¬¡æ•°=${state.cetPrepThisTerm}ã€‚`);
  consumeAction();
  afterAction();
}

/* ========== æ–°å¢è¡ŒåŠ¨ï¼šç¤¾äº¤/èšä¼šï¼ˆæé«˜ç¤¾äº¤ + å¥½è¿ï¼‰ ========== */
function doSocialize() {
  if (actionBlocked()) return;

  const cost = state.familyTier === "poor" ? 35 : state.familyTier === "ok" ? 60 : state.familyTier === "mid" ? 90 : 120;
  spend(cost, "èšä¼š/ç¤¾äº¤");

  state.energy = clamp(state.energy - 8, 0, 100);
  state.stress = clamp(state.stress - 10, 0, 100);
  applyMoodDelta(+6);

  state.social = clamp(state.social + 8, 0, 100);
  hiddenProfile.luck += 1.2;

  logLine(`ç¤¾äº¤ï¼šç¤¾äº¤+8ï¼Œå‹åŠ›ä¸‹é™ï¼ŒèŠ±è´¹-${cost}ã€‚`);
  consumeAction();
  afterAction();
}

/* ========== å…¶å®ƒè¡ŒåŠ¨ï¼ˆå°½é‡ä¿ç•™ä½ åŸé€»è¾‘ï¼‰ ========== */
function doWalk() {
  if (actionBlocked()) return;
  state.energy = clamp(state.energy + 12, 0, 100);
  state.stress = clamp(state.stress - 12, 0, 100);
  applyMoodDelta(+6);
  consumeAction();
  logLine("æ•£å¿ƒï¼šç²¾åŠ›+12ï¼Œå‹åŠ›-12ï¼Œå¿ƒæƒ…+6ã€‚");
  afterAction();
}
function doEat() {
  if (actionBlocked()) return;
  spend(30, "å¤§åƒä¸€é¡¿");
  state.energy = clamp(state.energy + 10, 0, 100);
  state.stress = clamp(state.stress - 6, 0, 100);
  applyMoodDelta(+8);
  consumeAction();
  logLine("å¤§åƒï¼šæ¢å¤çŠ¶æ€ï¼Œé‡‘é’±-30ã€‚");
  afterAction();
}
function doPartTime() {
  if (actionBlocked()) return;
  state.money += 260;
  state.energy = clamp(state.energy - 15, 0, 100);
  state.stress = clamp(state.stress + 12, 0, 100);
  hiddenProfile.careerPower += 0.5;
  consumeAction();
  logLine("å…¼èŒï¼šé‡‘é’±+260ï¼Œç²¾åŠ›-15ï¼Œå‹åŠ›+12ã€‚");
  checkBankruptcyLock();
  afterAction();
}
function doTravel() {
  if (actionBlocked()) return;
  const cost = state.familyTier === "poor" ? 220 : state.familyTier === "ok" ? 380 : state.familyTier === "mid" ? 650 : 900;
  spend(cost, "æ—…æ¸¸/å‡ºè¡Œ");
  state.energy = clamp(state.energy - 18, 0, 100);
  state.stress = clamp(state.stress - 18, 0, 100);
  applyMoodDelta(+10);
  consumeAction();
  logLine(`æ—…æ¸¸ï¼šé‡‘é’±-${cost}ï¼Œå‹åŠ›ä¸‹é™ï¼Œä½†ä¼šæŒ¤å ç²¾åŠ›ã€‚`);
  afterAction();
}
function doResearch() {
  if (actionBlocked()) return;

  if (state.route !== "research") {
    state.route = "research";
    logLine("ã€è·¯çº¿ã€‘è¿›å…¥ç§‘ç ”è·¯çº¿ï¼šä¹‹åç§‘ç ”ç±»äº‹ä»¶æ›´å¸¸å‡ºç°ã€‚");
  }

  state.energy = clamp(state.energy - 22, 0, 100);
  state.stress = clamp(state.stress + 18, 0, 100);
  applyMoodDelta(-4);

  hiddenProfile.researchPower += 1;

  state.termGradeBonus = clamp(state.termGradeBonus - 1, -5, 5);

  // âœ… SCIæ¦‚ç‡ï¼šç¤¾äº¤è¶Šé«˜è¶Šå®¹æ˜“é‡åˆ°èµ„æº/åˆä½œï¼ˆä½ è¦æ±‚ï¼‰
  // ä¸æ˜¯ç›´æ¥â€œå¤©é™SCIâ€ï¼Œè€Œæ˜¯ç»™ä¸€ä¸ªå°æ¦‚ç‡â€œé˜¶æ®µæ€§æˆæœâ€
  const s = clamp(state.social ?? 50, 0, 100);
  const p = 0.004 + (s / 1000) + clamp(hiddenProfile.researchPower, 0, 100) / 5000; // å¤§çº¦ 0.4%~1.5%/æ¬¡
  if (chance(p)) {
    state.sciCount += 1;
    state.recommendFlag = true;
    logLine(`ğŸ‰ã€ç§‘ç ”è¿›å±•ã€‘ä½ æ‹¿åˆ°äº†ä¸€ä¸ªé˜¶æ®µæ€§æˆæœï¼ˆç´¯è®¡æˆæœ=${state.sciCount}ï¼‰ã€‚ç¤¾äº¤å¸¦æ¥çš„èµ„æºæµåŠ¨å¸®äº†ä½ ä¸€æŠŠã€‚`);
  }

  consumeAction();
  logLine("åšç§‘ç ”ï¼šæ›´ç´¯æ›´å‹ï¼Œä½†ç§‘ç ”æ½œåŠ›+ï¼ˆæˆç»©ä¿®æ­£-1ï¼‰ã€‚");
  afterAction();
}
function doIntern() {
  if (actionBlocked()) return;
  state.money += 380;
  state.energy = clamp(state.energy - 16, 0, 100);
  state.stress = clamp(state.stress + 14, 0, 100);
  hiddenProfile.careerPower += 1;

  if (chance(0.06)) {
    state.disciplineFlag = true;
    hiddenProfile.stability -= 8;
    logLine("âš ï¸ã€å¤„åˆ†é£é™©ã€‘å®ä¹ å½±å“å‡ºå‹¤ï¼šäº§ç”Ÿå¤„åˆ†æ ‡è®°ã€‚");
  }

  consumeAction();
  logLine("å®ä¹ /é¡¹ç›®ï¼šé‡‘é’±+380ï¼Œå°±ä¸šæ½œåŠ›+ã€‚");
  checkBankruptcyLock();
  afterAction();
}
function doRetake() {
  if (actionBlocked()) return;
  state.energy = clamp(state.energy - 12, 0, 100);
  state.stress = clamp(state.stress + 10, 0, 100);
  state.termGradeBonus = clamp(state.termGradeBonus + 2, -5, 5);
  consumeAction();
  logLine("è¡¥æ•‘/é‡ä¿®ï¼šç²¾åŠ›-12ï¼Œå‹åŠ›+10ï¼Œæœ¬å­¦æœŸæˆç»©ä¿®æ­£+2ã€‚");
  afterAction();
}

if (ui.btnStudy) ui.btnStudy.addEventListener("click", doStudy);
if (ui.btnEnglish) ui.btnEnglish.addEventListener("click", doEnglish);
if (ui.btnSocialize) ui.btnSocialize.addEventListener("click", doSocialize);
if (ui.btnWalk) ui.btnWalk.addEventListener("click", doWalk);
if (ui.btnEat) ui.btnEat.addEventListener("click", doEat);
if (ui.btnPartTime) ui.btnPartTime.addEventListener("click", doPartTime);
if (ui.btnTravel) ui.btnTravel.addEventListener("click", doTravel);
if (ui.btnResearch) ui.btnResearch.addEventListener("click", doResearch);
if (ui.btnIntern) ui.btnIntern.addEventListener("click", doIntern);
if (ui.btnRetake) ui.btnRetake.addEventListener("click", doRetake);

/* ========== ç ´äº§ Modalï¼šè¦é’±/æ‰“å·¥ ========= */
function askParentsOncePerMonth() {
  if (!state.familyTier) return;
  const month = currentMonthIndex();
  if (state.lastAskParentsMonth === month) { logLine("ã€è¦é’±å¤±è´¥ã€‘æœ¬æœˆå·²ç»è¦è¿‡ä¸€æ¬¡é’±äº†ã€‚"); return; }
  state.lastAskParentsMonth = month;

  const amt = ASK_PARENTS_AMOUNT[state.familyTier] ?? 0;
  if (amt <= 0) { logLine("ã€è¦é’±å¤±è´¥ã€‘è´«å›°ï¼šè¦ä¸åˆ°é’±ã€‚"); return; }

  const before = state.money;
  state.money += amt;
  logLine(`ã€è¦é’±æˆåŠŸã€‘+${amt}ï¼ˆ${before}â†’${state.money}ï¼‰ã€‚`);
  checkBankruptcyLock();
  render();
}
function workOnceConsumesAction() {
  if (!isReadyToPlaySilent()) return;
  if (state.actionsLeft <= 0) { logLine("ã€æ‰“å·¥å¤±è´¥ã€‘æœ¬å‘¨è¡ŒåŠ¨å·²ç”¨å®Œã€‚"); return; }

  const before = state.money;
  state.money += WORK_REWARD;
  state.energy = clamp(state.energy - WORK_ENERGY_COST, 0, 100);
  state.stress = clamp(state.stress + WORK_STRESS_COST, 0, 100);

  consumeAction();
  logLine(`æ‰“å·¥ï¼šé‡‘é’±+${WORK_REWARD}ï¼ˆ${before}â†’${state.money}ï¼‰ï¼Œç²¾åŠ›-${WORK_ENERGY_COST}ï¼Œå‹åŠ›+${WORK_STRESS_COST}ã€‚`);
  checkBankruptcyLock();
  afterAction();
}
if (ui.btnAskParentsCenter) ui.btnAskParentsCenter.addEventListener("click", askParentsOncePerMonth);
if (ui.btnWorkCenter) ui.btnWorkCenter.addEventListener("click", workOnceConsumesAction);

/* ========== CET4/CET6ï¼šå›ºå®šå­¦æœŸå‘¨æ¬¡è€ƒè¯•ï¼ˆä½ é—®â€œå»å“ªäº†â€ï¼Œæˆ‘åŠ å›æ¥äº†ï¼‰ ==========
   - CET4ï¼šå¤§ä¸€ç¬¬äºŒå­¦æœŸ Week 8
   - CET6ï¼šå¤§äºŒç¬¬ä¸€å­¦æœŸ Week 8ï¼ˆéœ€å…ˆè¿‡ CET4ï¼‰
   é€šè¿‡æ¦‚ç‡ä¸ï¼šè‹±è¯­æ½œåŠ› + æœ¬å­¦æœŸå¤‡è€ƒæ¬¡æ•° + ç¤¾äº¤(ç¨³å®šå‘æŒ¥) + è¿æ°” æœ‰å…³
*/
function maybeRunCETExam() {
  const idx = termIndex1to8();       // 1..8
  if (state.week !== 8) return;

  const luck = calcLuckEffective();
  const social = clamp(state.social ?? 50, 0, 100);

  // CET4
  if (idx === 2 && !state.flags.cet4) {
    const prep = state.cetPrepThisTerm;
    const base = 0.35 + clamp(hiddenProfile.englishPower, 0, 100) / 250;
    const prepGain = clamp(prep, 0, 10) * 0.03;
    const socialStab = (social >= 80) ? 0.06 : (social >= 60) ? 0.03 : 0;
    const luckShift = (luck - 50) / 300;
    const p = clamp(base + prepGain + socialStab + luckShift, 0.05, 0.95);

    if (chance(p)) {
      state.flags.cet4 = true;
      logLine(`âœ…ã€CET-4ã€‘é€šè¿‡ï¼(pâ‰ˆ${(p * 100).toFixed(0)}%) ä½ æ­£å¼æ‹¥æœ‰äº†â€œå››çº§ç›¾ç‰Œâ€ã€‚`);
    } else {
      logLine(`âŒã€CET-4ã€‘æœªé€šè¿‡ã€‚(pâ‰ˆ${(p * 100).toFixed(0)}%) ä¸‹æ¬¡å†æˆ˜ã€‚`);
    }
  }

  // CET6
  if (idx === 3 && state.flags.cet4 && !state.flags.cet6) {
    const prep = state.cetPrepThisTerm;
    const base = 0.25 + clamp(hiddenProfile.englishPower, 0, 100) / 260;
    const prepGain = clamp(prep, 0, 12) * 0.025;
    const socialStab = (social >= 85) ? 0.06 : (social >= 65) ? 0.03 : 0;
    const luckShift = (luck - 50) / 320;
    const p = clamp(base + prepGain + socialStab + luckShift, 0.05, 0.92);

    if (chance(p)) {
      state.flags.cet6 = true;
      logLine(`âœ…ã€CET-6ã€‘é€šè¿‡ï¼(pâ‰ˆ${(p * 100).toFixed(0)}%) ä½ è§£é”äº†â€œæ›´å¼ºçš„è‹±è¯­æƒé™â€ã€‚`);
    } else {
      logLine(`âŒã€CET-6ã€‘æœªé€šè¿‡ã€‚(pâ‰ˆ${(p * 100).toFixed(0)}%) ç»§ç»­åˆ·ã€‚`);
    }
  }
}

/* =========================================================
   æˆç»©ç»“ç®—ï¼šæ¯é—¨è¯¾ç”¨è‡ªå·±çš„å­¦ä¹ æ¬¡æ•°
========================================================= */
function finalizeTermGrades() {
  if (!state.hasPickedWeek1 || state.coursesThisTerm.length === 0) {
    logLine("ã€å­¦æœŸç»“ç®—ã€‘æœ¬å­¦æœŸæœªé€‰è¯¾ï¼Œç•¥è¿‡æˆç»©ã€‚");
    return;
  }

  const report = {
    year: state.year,
    term: state.term,
    courses: [],
    termGPA: 0,
    termGpaCredits: 0,
    cumGPA: 0,
    cumGpaCredits: 0
  };

  const calc = window.GRADING?.calcCoursePercent;
  const toGp = window.GRADING?.percentToGradePoint;
  const gpFn = (percent) => (typeof toGp === "function" ? toGp(percent) : percentToGP(percent));

  let termPointSum = 0;
  let termCreditSum = 0;
  let earnedCredits = 0;
  const failedNames = [];

  for (const c of state.coursesThisTerm) {
    const perCourseStudyActions = state.studyActionsByCourseId?.[c.id] || 0;

    const raw = calc ? calc({
      course: c,
      studyActionsForThisCourse: perCourseStudyActions,
      totalStudyThisTerm: state.totalStudyThisTerm,
      finalsStudyWeeks: state.finalsStudyWeeksThisTerm,
      termBonus: state.termGradeBonus,
      energy: state.energy,
      stress: state.stress,
      disciplineFlag: state.disciplineFlag,
      conflictsResolved: state.conflictsResolved,
      flags: state.flags,
      social: state.social,
      luck: calcLuckEffective(),
      rand: Math.random
    }) : 60;

    const percent = clamp(Math.round(Number(raw)), 0, 100);
    const passed = percent >= 60;
    const gp = gpFn(percent);

    if (!passed) {
      failedNames.push(c.name);
      state.everFailed = true;
      state.failedCoursesPrimary += 1;
    } else {
      earnedCredits += c.credits;
    }

    if (c.required) {
      termPointSum += gp * c.credits;
      termCreditSum += c.credits;
      state.gpaRecord[c.id] = { credits: c.credits, gp };
    }

    report.courses.push({
      id: c.id,
      name: c.name,
      credits: c.credits,
      required: !!c.required,
      percent,
      gp: Number(Number(gp).toFixed(2)),
      passed
    });
  }

  state.termGPA = termCreditSum > 0 ? termPointSum / termCreditSum : 0;
  state.termGPARevealed = true;

  let cumPointSum = 0;
  let cumCreditSum = 0;
  for (const rec of Object.values(state.gpaRecord)) {
    cumPointSum += rec.gp * rec.credits;
    cumCreditSum += rec.credits;
  }
  state.cumGPA = cumCreditSum > 0 ? cumPointSum / cumCreditSum : 0;

  state.creditsEarnedTotal += earnedCredits;

  report.termGPA = Number(state.termGPA.toFixed(2));
  report.termGpaCredits = termCreditSum;
  report.cumGPA = Number(state.cumGPA.toFixed(2));
  report.cumGpaCredits = cumCreditSum;

  state.gradeHistory.push(report);

  // ä¸ç«‹åˆ»å…¬å¸ƒï¼šå…ˆå­˜ pendingï¼Œæ–°å­¦æœŸç¬¬1å‘¨å…¬å¸ƒ
  state.pendingTermReport = report;
  state.lastTermReport = null;
  state.termGPARevealed = false;

  if (failedNames.length > 0) logLine(`âŒã€æŒ‚ç§‘ã€‘æœ¬å­¦æœŸæŒ‚ç§‘ï¼š${failedNames.join("ã€")}`);
  else logLine("âœ…ã€é€šè¿‡ã€‘æœ¬å­¦æœŸæ‰€æœ‰è¯¾ç¨‹å‡é€šè¿‡ã€‚");

  logLine(`ã€å­¦æœŸç»“ç®—ã€‘å¿…ä¿®å­¦æœŸGPA=${report.termGPA}ï¼ˆåˆ†æ¯=${report.termGpaCredits}å­¦åˆ†ï¼‰ï¼Œç´¯è®¡GPA=${report.cumGPA}ï¼ˆåˆ†æ¯=${report.cumGpaCredits}å­¦åˆ†ï¼‰ã€‚`);
  logLine(`ã€å­¦åˆ†ã€‘æœ¬å­¦æœŸè·å¾—å­¦åˆ†=${earnedCredits}ï¼Œç´¯è®¡å·²ä¿®=${state.creditsEarnedTotal}/${state.graduationCreditsRequired}`);

  // æ¸…å­¦æœŸçŠ¶æ€
  state.coursesThisTerm = [];
  state.termCredits = 0;
  state.hasPickedWeek1 = false;
  state.hasAdjustedWeek3 = false;
  state.conflictsResolved = false;

  state.totalStudyThisTerm = 0;
  state.finalsStudyWeeksThisTerm = 0;
  state.termGradeBonus = 0;

  state.studyActionsByCourseId = {};
  state.masteredCourseIds = [];

  state.examSchedule = {};
  state.examConflicts = [];

  state.cetPrepThisTerm = 0;
}

function renderGrades() {
  if (!ui.gradeTable || !ui.gradeTermHeader || !ui.gradeHistory) return;

  const rep = state.lastTermReport;
  if (!rep) {
    setText(ui.gradeTermHeader, "æš‚æ— æˆç»©ï¼šå…ˆå®Œæˆä¸€ä¸ªå­¦æœŸçš„æœŸæœ«ç»“ç®—ã€‚");
    setHTML(ui.gradeTable, "");
    setHTML(ui.gradeHistory, "ï¼ˆè¿˜æ²¡æœ‰å†å²è®°å½•ï¼‰");
    return;
  }

  setText(
    ui.gradeTermHeader,
    `æœ€è¿‘ä¸€æ¬¡ï¼šç¬¬${rep.year}å­¦å¹´ ç¬¬${rep.term}å­¦æœŸ ï½œ å­¦æœŸGPA=${rep.termGPA}ï¼ˆå¿…ä¿®${rep.termGpaCredits}å­¦åˆ†ï¼‰ï½œ ç´¯è®¡GPA=${rep.cumGPA}ï¼ˆå¿…ä¿®${rep.cumGpaCredits}å­¦åˆ†ï¼‰`
  );

  const rows = rep.courses.map(c => {
    const tag = c.passed ? `<span class="tag ok">é€šè¿‡</span>` : `<span class="tag danger">æŒ‚ç§‘</span>`;
    const req = c.required ? "å¿…ä¿®(è®¡GPA)" : "é€‰ä¿®(ä¸è®¡GPA)";
    return `
      <tr>
        <td style="padding:8px;">${c.name}</td>
        <td style="padding:8px;">${req}</td>
        <td style="padding:8px;text-align:center;">${c.credits}</td>
        <td style="padding:8px;text-align:center;">${c.percent}</td>
        <td style="padding:8px;text-align:center;">${c.gp}</td>
        <td style="padding:8px;text-align:center;">${tag}</td>
      </tr>
    `;
  }).join("");

  setHTML(ui.gradeTable, `
    <table class="table" style="width:100%;border-collapse:collapse;">
      <thead>
        <tr>
          <th style="text-align:left;padding:8px;">è¯¾ç¨‹</th>
          <th style="text-align:left;padding:8px;">ç±»å‹</th>
          <th style="padding:8px;">å­¦åˆ†</th>
          <th style="padding:8px;">ç™¾åˆ†åˆ¶</th>
          <th style="padding:8px;">ç»©ç‚¹</th>
          <th style="padding:8px;">ç»“æœ</th>
        </tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>
  `);

  const hist = state.gradeHistory
    .slice()
    .reverse()
    .map(r => `ç¬¬${r.year}å­¦å¹´ ç¬¬${r.term}å­¦æœŸï¼šå­¦æœŸGPA=${r.termGPA}ï¼ˆå¿…ä¿®${r.termGpaCredits}å­¦åˆ†ï¼‰`)
    .join("<br/>");

  setHTML(ui.gradeHistory, hist || "ï¼ˆè¿˜æ²¡æœ‰å†å²è®°å½•ï¼‰");
}

function revealPendingGradesIfAny() {
  if (state.week !== 1) return;
  if (!state.pendingTermReport) return;

  state.lastTermReport = state.pendingTermReport;
  state.pendingTermReport = null;

  state.termGPARevealed = true;

  logLine("ğŸ“¢ã€æˆç»©å…¬å¸ƒã€‘ä¸Šå­¦æœŸæˆç»©å·²å‘å¸ƒï¼å·²è‡ªåŠ¨åˆ‡åˆ°ã€Œæˆç»©å•ã€é¡µã€‚");
  setTab("tabGrades");
}

/* ========== å‘¨å¾ªç¯ ========= */
function weeklyStressDrift() {
  const finalsMult = FINALS_WEEKS.includes(state.week) ? 2.0 : 1.0;
  state.stress = clamp(state.stress + Math.round(3 * finalsMult), 0, 100);
}

function depressionCheck() {
  if (state.stress >= 95) state.depressionWeeks += 1;
  else state.depressionWeeks = 0;

  if (state.depressionWeeks >= 3) {
    state.depressionWeeks = 0;

    state.year += 1;
    state.term = 1;
    state.week = 1;
    state.actionsLeft = ACTIONS_PER_WEEK;

    state.coursesThisTerm = [];
    state.termCredits = 0;
    state.hasPickedWeek1 = false;
    state.hasAdjustedWeek3 = false;
    state.conflictsResolved = false;

    state.totalStudyThisTerm = 0;
    state.finalsStudyWeeksThisTerm = 0;
    state.termGradeBonus = 0;

    state.studyActionsByCourseId = {};
    state.masteredCourseIds = [];

    state.currentEvent = null;
    state.eventPending = false;

    state.stress = 60;
    state.energy = 70;
    state.mood = 55;

    logLine("ã€ä¼‘å­¦ã€‘è¿ç»­å´©æºƒ3å‘¨ï¼šä½ ä¼‘å­¦ä¸€å¹´ï¼Œè·³åˆ°ä¸‹ä¸€å­¦å¹´ï¼ˆç°é‡‘ä¸å˜ï¼‰ã€‚");
  }
}

function endOfWeek() {
  weeklyStressDrift();
  depressionCheck();
  applyWeeklyLivingExpenses();
}

// âœ… é¿å… week=17
function startNextWeek() {
  if (state.week >= TERM_WEEKS) {
    finalizeTermGrades();
    state.week = 1;
    state.term += 1;

    if (state.term > TERMS_PER_YEAR) {
      state.term = 1;
      state.year += 1;
      logLine(`ã€å­¦å¹´åˆ‡æ¢ã€‘è¿›å…¥ç¬¬ ${state.year} å­¦å¹´ã€‚`);
    }
    logLine(`ã€å­¦æœŸåˆ‡æ¢ã€‘è¿›å…¥ç¬¬ ${state.term} å­¦æœŸã€‚`);
  } else {
    state.week += 1;
  }

  state.actionsLeft = ACTIONS_PER_WEEK;

  tickEventCooldowns();
  giveMonthlyAllowanceIfNeeded();
  ensureWeeklyEvent();

  revealPendingGradesIfAny();

  // âœ… ç¬¬3å‘¨è‡ªåŠ¨å¼¹é€€è¡¥é€‰ï¼ˆä½ è¦æ±‚ï¼‰
  if (state.week === 3 && state.hasPickedWeek1 && !state.hasAdjustedWeek3) {
    setTab("tabCourses");
    openAdjust(true);
  }

  render();
}

function afterAction() {
  checkBankruptcyLock();
  render();

  if (state.isBankruptLocked) return;

  // âœ… æ¯å‘¨æœ«ç»“ç®—æ—¶è§¦å‘ CET è€ƒè¯•åˆ¤å®šï¼ˆweek=8 çš„å‘¨æœ«ï¼‰
  // æ³¨æ„ï¼šè€ƒè¯•å†™åœ¨ startNextWeek å‰åéƒ½è¡Œï¼Œè¿™é‡Œæ”¾åœ¨â€œè¡ŒåŠ¨ç”¨å®Œè§¦å‘å‘¨æœ«â€ä¹‹å‰æ›´ç¬¦åˆâ€œå‘¨æœ«å‘ç”Ÿè€ƒè¯•â€
  if (state.actionsLeft <= 0) {
    // å‘¨æœ«
    endOfWeek();
    // CET è€ƒè¯•å‘ç”Ÿåœ¨å‘¨æœ«ï¼ˆweek=8ï¼‰
    maybeRunCETExam();
    // è¿›å…¥ä¸‹ä¸€å‘¨
    startNextWeek();
  }
}

if (ui.btnNextWeek) ui.btnNextWeek.addEventListener("click", () => {
  if (!isReadyToPlaySilent()) return;
  if (state.eventPending) { logLine("ã€æœ¬å‘¨äº‹ä»¶ã€‘å…ˆé€‰æœ¬å‘¨äº‹ä»¶ï¼Œæ‰èƒ½è¿›å…¥ä¸‹ä¸€å‘¨ã€‚"); return; }
  endOfWeek();
  maybeRunCETExam();
  startNextWeek();
});

/* ========== æ¸²æŸ“ ========= */
function render() {
  setText(ui.year, state.year);
  setText(ui.term, state.term);
  setText(ui.week, `${state.week}ï¼ˆæœˆ${termMonthIndex()}ï¼‰`);
  setText(ui.actionsLeft, state.actionsLeft);

  setText(ui.academyName, state.academy ?? "æœªé€‰");
  setText(ui.familyTier, state.familyTier ? tierName(state.familyTier) : "æœªé€‰");

  setText(ui.cet4Flag, state.flags?.cet4 ? "å·²é€šè¿‡" : "æœªé€šè¿‡");
  setText(ui.cet6Flag, state.flags?.cet6 ? "å·²é€šè¿‡" : "æœªé€šè¿‡");
  if (ui.certList) {
    setHTML(ui.certList, `CET-4ï¼š${state.flags?.cet4 ? '<b>å·²é€šè¿‡</b>' : 'æœªé€šè¿‡'}ï¼›CET-6ï¼š${state.flags?.cet6 ? '<b>å·²é€šè¿‡</b>' : 'æœªé€šè¿‡'} <div style="margin-top:8px"><button class="btn" id="btnTakeCET">å‚åŠ è‹±è¯­è€ƒè¯•ï¼ˆæ‰‹åŠ¨è§¦å‘ï¼‰</button></div>`);
    const btn = byId('btnTakeCET'); if (btn) btn.onclick = () => { maybeRunCETExam(); render(); };
  }

  setText(ui.energy, state.energy);
  setText(ui.stress, state.stress);
  setText(ui.mood, state.mood);
  setText(ui.social, state.social);
  setText(ui.money, state.money);

  setText(ui.gradCreditsReq, state.graduationCreditsRequired || "-");
  setText(ui.creditsEarnedTotal, state.creditsEarnedTotal);
  setText(ui.termCredits, state.termCredits);
  setText(ui.courseCount, state.coursesThisTerm.length);

  const cumCredits = Object.values(state.gpaRecord).reduce((s, r) => s + (r.credits || 0), 0);
  setText(ui.termGPA, state.termGPARevealed ? state.termGPA.toFixed(2) : "??");
  setText(ui.cumGPA, `${state.cumGPA.toFixed(2)}ï¼ˆå¿…ä¿®å·²å‡ºåˆ†${cumCredits}å­¦åˆ†ï¼‰`);

  setText(ui.failedCourses, state.failedCoursesPrimary);
  setText(ui.disciplineFlag, state.disciplineFlag ? "æœ‰ï¼ˆå°é”ï¼‰" : "æ— ");
  setText(ui.recommendFlag, state.recommendFlag ? "å·²è·å¾—" : "æœªè·å¾—");

  setWidth(ui.barEnergy, state.energy + "%");
  setWidth(ui.barStress, state.stress + "%");
  setWidth(ui.barMood, state.mood + "%");
  setWidth(ui.barSocial, state.social + "%");
  setWidth(ui.barMoney, Math.min(100, Math.floor(state.money / 3000 * 100)) + "%");

  renderCourseSummary();
  renderConflictPanel();
  renderEventCard();
  renderActionPanel();

  const blockActions = !isReadyToPlaySilent() || state.isBankruptLocked || state.eventPending;
  [
    ui.btnStudy, ui.btnEnglish, ui.btnSocialize, ui.btnWalk, ui.btnEat, ui.btnPartTime,
    ui.btnTravel, ui.btnResearch, ui.btnIntern, ui.btnRetake, ui.btnNextWeek
  ].forEach(b => setDisabled(b, blockActions));

  let hint = "";
  if (!state.academy) hint = "å…ˆé€‰å­¦é™¢ç”ŸæˆåŸ¹å…»æ–¹æ¡ˆã€‚";
  else if (!state.familyTier) hint = "å†é€‰å®¶å¢ƒï¼ˆå¼€å±€é”æ­»ï¼‰ã€‚";
  else if (state.isBankruptLocked) hint = "ç ´äº§é”æ­»ï¼šå…ˆè¦é’±/æ‰“å·¥ã€‚";
  else if (state.eventPending) hint = "å…ˆé€‰æ‹©ã€æœ¬å‘¨äº‹ä»¶ã€‘ï¼Œæ‰èƒ½è¡ŒåŠ¨ã€‚";
  else if (state.week === 1 && !state.hasPickedWeek1) hint = "ç¬¬1å‘¨å¿…é¡»å…ˆé€‰è¯¾ï¼ˆå»â€œé€‰è¯¾&è€ƒè¯•â€é¡µï¼‰ã€‚";
  else hint = "æ¯å‘¨åªèƒ½åš3ä»¶äº‹ï¼Œç‚¹æ»¡ä¼šè‡ªåŠ¨è¿›å…¥ä¸‹ä¸€å‘¨ã€‚";
  setText(ui.statusHint, hint);

  renderGrades();
  openBankruptModalIfNeeded();
}

/* ========== åˆå§‹åŒ– ========= */
logLine("æ¬¢è¿æ¥åˆ°å¤§å­¦ç”Ÿæ¨¡æ‹Ÿå™¨ v0.4ã€‚");
logLine("å»â€œæ¦‚è§ˆâ€ï¼šå…ˆé€‰å­¦é™¢ï¼Œå†é€‰å®¶å¢ƒï¼ˆå¼€å±€é”æ­»ï¼‰ã€‚");
logLine("å»â€œæœ¬å‘¨&æ—¥å¿—â€ï¼šå…ˆé€‰æœ¬å‘¨äº‹ä»¶ï¼Œå†åšè¡ŒåŠ¨ï¼ˆæ¯å‘¨3æ¬¡ï¼‰ã€‚");
logLine("å»â€œé€‰è¯¾&è€ƒè¯•â€ï¼šç¬¬1å‘¨æŒ‰åŸ¹å…»æ–¹æ¡ˆè‡ªåŠ¨é€‰è¯¾ï¼ˆå¼ºåˆ¶è¯¾é”æ­»ï¼‰ï¼Œç¬¬3å‘¨é€€è¡¥é€‰å¯è¡¥é€‰+é€€è¯¾ï¼Œç›´åˆ°æ— å†²çªã€‚");
logLine("CET-4/6ï¼šé€šè¿‡â€œåˆ·è‹±è¯­â€æé«˜é€šè¿‡ç‡ã€‚");

render();
setTab("tabOverview");
